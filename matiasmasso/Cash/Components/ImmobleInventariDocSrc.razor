@inject ApiService ApiService
<div class="PageWrapper600">

    <Title Value="Assignar un document a una partida de l'inventari'" CloseRequest="HandleCloseRequest"></Title>

    <PropertyGrid Model="propertyGrid"
                  ItemChanged="ItemChanged"
                  UpdateRequest="UpdateAsync"
                  DeleteRequest="DeleteAsync"
                  CancelRequest="HandleCloseRequest"
                  UpdateState="UpdateState()"
                  DeleteState="deleteState">
    </PropertyGrid>

    <Error @bind-Value="exception"></Error>
</div>
@code {
    [Parameter] public DocfileSrcModel? Value { get; set; }
    [Parameter] public EventCallback<DocfileSrcModel> AfterUpdate { get; set; }
    [Parameter] public EventCallback<DocfileSrcModel> AfterDelete { get; set; }
    [Parameter] public EventCallback CloseRequest { get; set; }
    private DocfileSrcModel? value;
    private DocfileModel? docfile;
    private PropertyGridModel? propertyGrid;
    private CrudButton.States updateState;
    private CrudButton.States deleteState;
    private EmpModel.EmpIds emp;

    private Exception? exception;

    enum Fields
    {
        Emp,
        Fch,
        Nom,
        Docfile
    }

    protected override void OnInitialized()
    {
        emp = (EmpModel.EmpIds)ApiService.Emp!;
    }

    protected override void OnParametersSet()
    {
        value = Value;
        propertyGrid = PropertyGrid();
    }

    PropertyGridModel PropertyGrid()
    {
        var retval = new PropertyGridModel();
        retval.AddEmp(emp);
        retval.AddDateTime("Data", value?.Docfile?.Fch ?? DateTime.Now);
        retval.AddString("Concepte", value?.Docfile?.Nom, 60);
        retval.AddDocfile(value?.Docfile);
        propertyGrid = retval;
        return retval;
    }

    void ItemChanged(PropertyGridModel.Item args)
    {
        if (args.Format == PropertyGridModel.Formats.EmpId)
        {
            emp = ((PropertyGridModel.Item<EmpModel.EmpIds>)args).Value;
            propertyGrid = PropertyGrid();
        }
    }


    async Task UpdateAsync()
    {
        updateState = CrudButton.States.Loading;
        try
        {
            value!.Docfile = propertyGrid!.GetDocfile((int)Fields.Docfile);
            value!.Docfile!.Fch = propertyGrid!.GetDateTime((int)Fields.Fch);
            value.Docfile.Nom = propertyGrid!.Value<string>((int)Fields.Nom);
            value.Cod = DocfileModel.Cods.download;
            await ApiService.PostMultipartAsync<DocfileSrcModel, bool>(value.Docfile, value, "DocFileSrc");
            await AfterUpdate.InvokeAsync(value);
        }
        catch (Exception ex)
        {
            exception = ex;
        }
        updateState = CrudButton.States.StandBy;
    }

    async Task DeleteAsync()
    {
        deleteState = CrudButton.States.Loading;
        try
        {
            await ApiService.PostAsync<DocfileSrcModel, bool>(value!, "DocFileSrc/delete");
            await AfterDelete.InvokeAsync(value);
        }
        catch (Exception ex)
        {
            exception = ex;
        }
        deleteState = CrudButton.States.StandBy;
    }



    CrudButton.States UpdateState() => updateState;

    void HandleCloseRequest()
    {
        CloseRequest.InvokeAsync();
    }
}

