@inject ApiService ApiService
@implements IDisposable

@if (contactToAdd == null)
{
    <PropertyGrid Model="propertyGrid"
        ZoomRequest="ZoomRequestHandler"
    UpdateRequest="UpdateRequestHandler"
    CancelRequest="HandleCloseRequest"
    DeleteRequest="DeleteRequestHandler"
    ItemChanged="HandleItemChanged"
    UpdateState="updateState"
    DeleteState="deleteState">
    </PropertyGrid>
}
else
{
    <Contact Value="contactToAdd"
    CloseRequest="@(()=>contactToAdd=null)"
    AfterUpdate="HandleOnContactAdded"></Contact>
}


@code {
    [Parameter] public CcaModel? Cca { get; set; }
    [Parameter] public CcaModel.Item? Value { get; set; }
    [Parameter] public EventCallback<CcaModel.Item> ValueChanged { get; set; }
    [Parameter] public EventCallback<IModel> ZoomRequest { get; set; }
    [Parameter] public EventCallback<CcaModel.Item> DeleteRequest { get; set; }
    [Parameter] public EventCallback CloseRequest { get; set; }
    [Parameter] public EventCallback AddContactRequest { get; set; }

    List<PgcCtaModel>? ctas;
    List<ContactModel>? contacts;
    ContactModel? contactToAdd;
    PropertyGridModel? propertyGrid;
    CrudButton.States updateState;
    CrudButton.States deleteState;
    Exception? exception;

    enum Fields
    {
        Cta,
        Contact,
        Eur,
        Dh
    }


    protected override void OnInitialized()
    {
        ApiService.OnChange += Refresca;
    }


    protected override void OnParametersSet()
    {
        Refresca();
    }

    void Refresca(Exception? ex = null)
    {
        exception = ex;
        ctas = ApiService.GetCurrentPgcCtas();
        contacts = ApiService.GetContacts();
        propertyGrid = PropertyGrid(Value!);
    }

    PropertyGridModel PropertyGrid(CcaModel.Item value)
    {
        contacts = contacts?.Where(x => x.Emp == Cca?.Emp).ToList();
        var retval = new PropertyGridModel();
        retval.AddGuidnom("Compte", value?.Cta, ctas);
        //retval.AddGuidnom("Subcompte", value?.Contact, contacts, HandleAddContact);
        retval.AddModel("Subcompte", value?.Contact, contacts, HandleAddContact);
        retval.AddEur("Import", value?.Eur);
        retval.AddIdNom("Signe", ((int?)value?.Dh) - 1, new string[] { "deure", "haver" });
        return retval;
    }

    async Task HandleCloseRequest()
    {
        await CloseRequest.InvokeAsync();
    }

    void ZoomRequestHandler(IModel args)
    {
        ZoomRequest.InvokeAsync(args);
    }


    void UpdateRequestHandler()
    {
        var cta = propertyGrid!.GetGuid((int)Fields.Cta);
        var eur = propertyGrid!.GetEur((int)Fields.Eur);
        if (cta != null && eur != null)
        {
            var contact = propertyGrid.GetModelGuid((int)Fields.Contact);
            var dh = propertyGrid.GetId((int)Fields.Dh);

            var value = Value!;
            value.Cta = (Guid)cta;
            value.Contact = contact;
            value.Eur = (decimal)eur;
            value.Dh = (CcaModel.Item.DhEnum)(dh! + 1);
            ValueChanged.InvokeAsync(value);
        }
        else
            exception = new Exception("Compte o import buits");
    }

    async Task DeleteRequestHandler()
    {
        await DeleteRequest.InvokeAsync(Value);
    }

    void AfterAddDespesa(CcaModel args)
    {
        // year = ((DateOnly)args.Fch!).Year;
        // tab = Tabs.Extracte;
    }

    void HandleItemChanged(PropertyGridModel.Item args)
    {
        // if (args.Format == PropertyGridModel.Formats.EmpId)
        // {
        //     value!.Emp = ((PropertyGridModel.Item<EmpModel.EmpIds>)args).Value;
        //     propertyGrid = PropertyGrid();
        // }
    }

    void HandleCcaRequest(CcaModel args)
    {
        // selectedCca = args;
    }

    public void Dispose()
    {
        ApiService.OnChange -= Refresca;
    }

    void HandleAddContact()
    {
        contactToAdd = new ContactModel
            {
                Emp = (EmpModel.EmpIds)ApiService.Emp!,
                RaoSocial = "(Nou contacte)"
            };
    }

    void HandleOnContactAdded(ContactModel args)
    {
        var previous = contacts!.FirstOrDefault(x => x.Guid == args.Guid);
        if (previous == null)
            contacts!.Add(args);
        else
        {
            var idx = contacts!.IndexOf(previous);
            contacts[idx] = args;
        }

        var value = Value!;
        value.Cta = propertyGrid!.GetGuid((int)Fields.Cta);
        value.Contact = args?.Guid;
        value.Eur = (decimal?)(propertyGrid!.GetEur((int)Fields.Eur)) ?? 0;
        value.Dh = (CcaModel.Item.DhEnum)(propertyGrid!.GetId((int)Fields.Dh)! + 1);
        propertyGrid = PropertyGrid(value);
        contactToAdd = null;
    }
}

