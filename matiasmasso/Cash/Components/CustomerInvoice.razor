@inject ApiService ApiService

<div class="PageWrapper600">
        @if (selectedItem != null)
    {
        <Model Value="selectedItem"
            CloseRequest="@(() => selectedItem=null)"
        AfterUpdate="AfterUpdateItemRequestAsync"></Model>
    } 
    else
    {
        <h3>Customer Invoice</h3>

        <PageOptions>
            <PageOptions>
                <a href="#" @onclick="AddItemRequest" @onclick:preventDefault>afegir linia</a>
            </PageOptions>
        </PageOptions>

        <CustomerInvoiceItems Value="value" EditRequest="EditItemRequest" OnDelete="HandleOnItemDelete"></CustomerInvoiceItems>

        <PropertyGrid Model="propertyGrid"
                      UpdateRequest="UpdateAsync"
                      ItemChanged="HandleItemChanged"
                      CancelRequest="HandleCancelRequest"
                      UpdateState="updateState"
                      DeleteState="deleteState">
        </PropertyGrid>
    }
    <Error @bind-Value="exception"></Error>
</div>
@code {
    [Parameter] public CustomerInvoiceModel Value { get; set; }
    [Parameter] public EventCallback<CustomerInvoiceModel> AfterUpdate { get; set; }
    [Parameter] public EventCallback CancelRequest { get; set; }

    CustomerInvoiceModel? value { get; set; }
    List<PgcCtaModel>? ctas;
    List<ContactModel>? allContacts;
    List<ContactModel>? contacts;
    ContactModel? contactToAdd;
    PropertyGridModel? propertyGrid;
    CrudButton.States updateState;
    CrudButton.States deleteState;
    private CustomerInvoiceModel.Item? selectedItem;
    // private List<CustomerInvoiceModel.LastFraNum>? lastFraNums;
    // private List<CustomerInvoiceModel.Template>? templates;
    // private CustomerInvoiceModel.Template? selectedTemplate;
    // bool isEditingTemplate = false;
    // bool hasLoadedTemplate = false;

    Exception? exception;

    enum Fields
    {
        Emp,
        Contact,
        RaoSocial,
        Address,
        Zip,
        Nif,
        Lang,
        FraNum,
        Fch,
        IvaPct,
        IrpfPct,
        Total,
        CtaCredit,
        CtaDebit,
        VfConcept,
        VfTaxScheme,
        VfTaxType,
        VfTaxException,
        Docfile
    }


    protected override async Task OnInitializedAsync()
    {
        ApiService.OnChange += Refresca;

        ctas = ApiService.GetCurrentPgcCtas();
        allContacts = ApiService.GetContacts();
        //lastFraNums = await ApiService.GetAsync<List<CustomerInvoiceModel.LastFraNum>>("fras/lastfranums");
        // var allTemplates = await ApiService.GetAsync<List<CustomerInvoiceModel.Template>>("CustomerInvoiceTemplates");
        // templates = allTemplates?.Where(x => x.Emp == Emp).ToList();
        // selectedTemplate = templates?.FirstOrDefault();
        // if(selectedTemplate != null)
        // {
        //     value = await ValueFromTemplateAsync();
        //     Refresca();
        // }
    }

    protected override void OnParametersSet()
    {
        base.OnParametersSet();
        value = Value;
        Refresca();
    }

    void Refresca(Exception? ex = null)
    {
        exception = ex;
        propertyGrid = PropertyGrid(value!);
    }

    PropertyGridModel PropertyGrid(CustomerInvoiceModel value)
    {
        contacts = allContacts?.Where(x => x.Emp == value?.Emp).ToList();
        var retval = new PropertyGridModel();
        retval.AddEmp(value?.Emp);
        //retval.AddGuidnom("Subcompte", value?.Contact, contacts, HandleAddContact);
        retval.AddModel("Client", value?.Customer, contacts, HandleAddContact);
        retval.AddString("Rao Social", value?.RaoSocial);
        retval.AddString("Adreça", value?.Address);
        retval.AddModel("Població", value?.Zip?.Guid, ApiService.GetZipNoms()?.ToArray());
        retval.AddString("Nif", value?.NIF);
        retval.AddString("Lang", value?.Lang?.ToString());
        retval.AddInt("Factura", value?.FraNum);
        retval.AddDateOnly("Data", value?.Fch);
        retval.AddDecimal("IVA", value?.IVApct);
        retval.AddDecimal("IRPF", value?.IRPFpct);
        retval.AddEur("Total", value?.Total);
        retval.AddGuidnom("Compte credit", value?.CtaCredit, ctas);
        retval.AddGuidnom("Compte debit", value?.CtaDebit, ctas);
        retval.AddString("Vf Concepte", value?.VfConcept);
        retval.AddString("Vf TaxScheme", value?.VfTaxScheme);
        retval.AddString("Vf TaxType", value?.VfTaxType);
        retval.AddString("Vf TaxException", value?.VfTaxException);
        retval.AddDocfile(value?.Docfile);

        return retval;
    }

    CustomerInvoiceModel? CurrentValue()
    {
        var retval = value;
        if (retval != null)
        {
            retval.Emp = propertyGrid!.GetEmp((int)Fields.Emp);
            retval.Customer = propertyGrid.GetModelGuid((int)Fields.Contact);
            retval.RaoSocial = propertyGrid.GetString((int)Fields.RaoSocial);
            retval.Address = propertyGrid.GetString((int)Fields.Address);
            retval.Zip = ApiService.GetFullZip(propertyGrid!.GetModelGuid((int)Fields.Zip));
            retval.NIF = propertyGrid.GetString((int)Fields.Nif);
            retval.Lang = new LangDTO(propertyGrid.GetString((int)Fields.Lang));
            retval.FraNum = (int)propertyGrid.GetInt((int)Fields.FraNum)!;
            retval.Fch = (DateOnly)propertyGrid!.GetDateOnly((int)Fields.Fch)!;
            retval.Vto = retval.Fch;
            retval.IVApct = propertyGrid.GetDecimal((int)Fields.IvaPct);
            retval.IRPFpct = propertyGrid!.GetDecimal((int)Fields.IrpfPct);
            retval.CtaCredit = propertyGrid.GetGuidNom((int)Fields.CtaCredit)?.Guid;
            retval.CtaDebit = propertyGrid.GetGuidNom((int)Fields.CtaDebit)?.Guid;
            retval.VfConcept = propertyGrid!.GetString((int)Fields.VfConcept);
            retval.VfTaxScheme = propertyGrid!.GetString((int)Fields.VfTaxScheme);
            retval.VfTaxType = propertyGrid!.GetString((int)Fields.VfTaxType);
            retval.VfTaxException = propertyGrid!.GetString((int)Fields.VfTaxException);
            retval.Docfile = propertyGrid.GetDocfile((int)Fields.Docfile);
        }
        return retval;
    }

    void AddItemRequest()
    {
        selectedItem = new CustomerInvoiceModel.Item();
    }

    async Task AfterUpdateItemRequestAsync(IModel args)
    {
        var item = (CustomerInvoiceModel.Item)args;
        var idx = value!.Items.FirstOrDefault(x => x.Guid == args.Guid);
        if (idx == null)
            value.Items.Add(item);
        else
        {
            var index = value.Items.IndexOf(idx);
            value.Items[index] = item;
        }
        RefrescaTotals();
        value!.Docfile = await CreateDocfileAsync(value);
        selectedItem = null;
        await InvokeAsync(StateHasChanged);
    }

    async Task TestAsync(List<CustomerInvoiceModel.Item> args)
    {
        value = CurrentValue();
        value!.Items = args;
        RefrescaTotals();

        value!.Docfile = await CreateDocfileAsync(value);
        Refresca();
    }

    async Task HandleOnItemDelete(CustomerInvoiceModel.Item args)
    {
        value = CurrentValue();
        var item = value!.Items.FirstOrDefault(x => x.Guid == args.Guid);
        if (item != null)
        {
            value.Items.Remove(item);
        }
        RefrescaTotals();
        value!.Docfile = await CreateDocfileAsync(value);
        Refresca();
    }

    // async Task HandleCloseRequest()
    // {
    //     await CloseRequest.InvokeAsync();
    // }

    // void ZoomRequestHandler(IModel args)
    // {
    //     ZoomRequest.InvokeAsync(args);
    // }

    void RefrescaTotals()
    {
        value = CurrentValue();
        var itemTotal = (PropertyGridModel.Item<string>)(propertyGrid!.GetItem((int)Fields.Total));
        itemTotal.Value = ((decimal)value!.Total).ToString("0.00", propertyGrid.Culture);
        // var idx = propertyGrid.Items.IndexOf(itemTotal);
        // propertyGrid.Items[idx] = new PropertyGridModel.Item<string>(itemTotal.Caption, ((decimal)value!.Total).ToString("0.00", propertyGrid.Culture), PropertyGridModel.Formats.Eur);
    }



    async Task UpdateAsync()
    {
        updateState = CrudButton.States.Loading;
        try
        {
            var value = CurrentValue();
            if (value != null)
            {
                await ApiService.PostMultipartAsync<CustomerInvoiceModel, bool>(value.Docfile, value, "CustomerInvoice/update");
                //await AfterUpdate.InvokeAsync(fra);
            }
        }
        catch (Exception ex)
        {
            exception = ex;
        }
        updateState = CrudButton.States.StandBy;
        await AfterUpdate.InvokeAsync(value);
    }

    async Task DeleteRequestHandler()
    {
        // await DeleteRequest.InvokeAsync(Value);
    }

    void AfterAddDespesa(CcaModel args)
    {
        // year = ((DateOnly)args.Fch!).Year;
        // tab = Tabs.Extracte;
    }

    async Task HandleItemChanged(PropertyGridModel.Item args)
    {
        value = CurrentValue();
        value!.Docfile = await CreateDocfileAsync(value);
        Refresca();
    }

    async Task<DocfileModel?> CreateDocfileAsync(CustomerInvoiceModel value)
    {
        var pdf = await ApiService.PostAsync<CustomerInvoiceModel, Byte[]>(value, "CustomerInvoice/Pdf");
        var media = new Media(Media.MimeCods.Pdf, pdf);
        var retval = DocfileHelper.CreateDocfile(media, 350, 400);
        return retval;
    }

    void HandleCcaRequest(CcaModel args)
    {
        // selectedCca = args;
    }

    public void Dispose()
    {
        ApiService.OnChange -= Refresca;
    }

    void HandleAddContact()
    {
        contactToAdd = new ContactModel
        {
            Emp = (EmpModel.EmpIds)ApiService.Emp!,
            RaoSocial = "(Nou contacte)"
        };
    }

    void HandleOnContactAdded(ContactModel args)
    {
        var previous = contacts!.FirstOrDefault(x => x.Guid == args.Guid);
        if (previous == null)
            contacts!.Add(args);
        else
        {
            var idx = contacts!.IndexOf(previous);
            contacts[idx] = args;
        }

        // var value = Value!;
        // value.Cta = propertyGrid!.GetGuid((int)Fields.Cta);
        // value.Contact = args?.Guid;
        // value.Eur = (decimal?)(propertyGrid!.GetEur((int)Fields.Eur)) ?? 0;
        // value.Dh = (CcaModel.Item.DhEnum)(propertyGrid!.GetId((int)Fields.Dh)! + 1);
        // propertyGrid = PropertyGrid(value);
        // contactToAdd = null;
    }

    void EditItemRequest(CustomerInvoiceModel.Item args)
    {
        selectedItem = args;
    }

    void HandleCancelRequest()
    {
        CancelRequest.InvokeAsync();
    }
}

