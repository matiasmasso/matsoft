@inject ApiService ApiService
@implements IDisposable


@if (value == null)
{
    <Loading></Loading>
} else if (isAddingNewLocation)
{
    <Location AddNewRequest="()=> isAddingNewLocation=false"
         AfterUpdate="(zip) => { isAddingNewLocation = false; propertyGrid = PropertyGrid(); }"
         CloseRequest="()=> isAddingNewLocation=false"></Location>
}
else if (selectedTel != null)
{
    <div>
        <PropertyGrid Model="telPropertyGrid"
                      CancelRequest="@(()=>selectedTel=null)"
                      UpdateRequest="HandleTelUpdateRequest"
                      UpdateState="updateTelState">
        </PropertyGrid>

    </div>
}
else if (selectedEmail != null)
{
    <div>
        <PropertyGrid Model="emailPropertyGrid"
                      CancelRequest="@(()=>selectedEmail=null)"
                      UpdateRequest="HandleEmailUpdateRequest"
                      UpdateState="updateEmailState">
        </PropertyGrid>

    </div>
}
else if (selectedTab == Tabs.Detalls)
{
    <div class="PageWrapper600">
        <Title Value="@Value?.FullNom" CloseRequest="HandleCloseRequest"></Title>

        <Tabs Value="(int?)selectedTab" ValueChanged="HandleTabChanged" Captions="Detalls, Comptes, Correspondencia, Documents"></Tabs>

        <PropertyGrid Model="propertyGrid"
        ZoomRequest="ZoomRequestHandler"
        CancelRequest="HandleCloseRequest"
        UpdateRequest="HandleUpdateRequestAsync"
        DeleteRequest="HandleDeleteRequestAsync"
        ItemChanged="HandleItemChanged"
        UpdateState="updateState"
        DeleteState="deleteState">
        </PropertyGrid>

    </div>
}
else if (selectedTab == Tabs.Comptes)
{
    <ContactCtas Contact="Value" CloseRequest="HandleCloseRequest"></ContactCtas>
}

else if (selectedTab == Tabs.Correspondencia)
{
    <ContactCorrespondencia Contact="Value" CloseRequest="HandleCloseRequest"></ContactCorrespondencia>
}
else if (selectedTab == Tabs.Documents)
{
            <Title Value="@Value?.FullNom" CloseRequest="HandleCloseRequest"></Title>

            <Tabs Value="(int?)selectedTab" ValueChanged="HandleTabChanged" Captions="Detalls, Comptes, Correspondencia, Documents"></Tabs>
    
            <ContactDocs Model="Value" CloseRequest="HandleCloseRequest"></ContactDocs>
}

<Error @bind-Value="exception"></Error>

@code {
    [Parameter] public ContactModel? Value { get; set; }
    [Parameter] public EventCallback<ContactModel> AfterUpdate { get; set; }
    [Parameter] public EventCallback<ContactModel> AfterDelete { get; set; }
    [Parameter] public EventCallback CloseRequest { get; set; }

    ContactModel? value;
    List<ContactClassModel>? contactClasses;
    Tabs? selectedTab = Tabs.Detalls;
    Options? option;

    PropertyGridModel? propertyGrid;
    PropertyGridModel? telPropertyGrid;
    PropertyGridModel? emailPropertyGrid;

    CrudButton.States updateState;
    CrudButton.States deleteState;
    CrudButton.States updateTelState;
    CrudButton.States updateEmailState;
    ContactModel.Telefon? selectedTel;
    ContactModel.Email? selectedEmail;

    bool isAddingNewLocation;

    Exception? exception;

    enum Tabs
    {
        Detalls,
        Comptes,
        Correspondencia,
        Documents
    }

    enum Fields
    {
        Emp,
        RaoSocial,
        NomComercial,
        Nif,
        ContactClass,
        Adr,
        Zip,
        Tels,
        Emails,
        Obsolet
    }

    enum TelFields
    {
        TelNum,
        Country,
        Obs
    }

    enum EmailFields
    {
        EmailAddress,
        Rol,
        Obs,
        Obsoleto
    }


    public enum Options
    {
        Comptes,
        Correspondencia
    }

    protected override void OnInitialized()
    {
        base.OnInitialized();
        ApiService.OnChange += Refresca;
    }

    protected override async Task OnParametersSetAsync()
    {
        try
        {
            if (Value!.IsNew)
            {
                value = Value;
                deleteState = CrudButton.States.Hidden;
            }
            else
                value = value ?? await ApiService.GetAsync<ContactModel>("Contact", Value.Guid.ToString());

            if (contactClasses == null) contactClasses = await ApiService.GetAsync<List<ContactClassModel>>("ContactClasses");
            Refresca();
        }
        catch (Exception ex)
        {
            exception = ex;
        }
    }

    void Refresca(Exception? ex = null)
    {
        exception = ex;
        propertyGrid = PropertyGrid();
    }

    PropertyGridModel PropertyGrid()
    {
        var retval = new PropertyGridModel();
        retval.AddEmp(value?.Emp);
        retval.AddString("Rao social", value?.RaoSocial);
        retval.AddString("Nom comercial", value?.NomComercial);
        retval.AddString("Nif", value?.Nifs.FirstOrDefault()?.Value);
        retval.AddGuidnom("Classe", value?.ContactClass, contactClasses);
        retval.AddString("Adreça", value?.Address?.Text);
        retval.AddGuidnom("Població", value?.Address?.Zip?.Guid, ApiService.GetZipNoms(), AddNewLocation);
        retval.AddModels<ContactModel.Telefon>("Tels", null,value?.Telefons, HandleAddNewTel);
        retval.AddModels<ContactModel.Email>("Emails", null, value?.Emails, HandleAddNewEmail);
        retval.AddBool("Obsolet", value?.Obsoleto);
        return retval;
    }


    void ZoomRequestHandler(IModel args)
    {
        if(args is ContactModel.Telefon)
        {
            selectedTel = (ContactModel.Telefon)args;
            telPropertyGrid = TelPropertyGrid();
        }
        else if (args is ContactModel.Email)
        {
            selectedEmail = (ContactModel.Email)args;
            emailPropertyGrid = EmailPropertyGrid();
        }
    }

    void HandleAddNewTel()
    {
        selectedTel = new ContactModel.Telefon();
        selectedTel.Country = CountryModel.Spain();
        telPropertyGrid = TelPropertyGrid();
    }

    void HandleAddNewEmail()
    {
        selectedEmail = new ContactModel.Email();
        emailPropertyGrid = EmailPropertyGrid();
    }

    PropertyGridModel TelPropertyGrid()
    {
        var countries = ApiService.GetCountries();
        var retval = new PropertyGridModel();
        retval.AddString("Telèfon", selectedTel?.Number);
        retval.AddModel<CountryModel>("Pais", selectedTel?.Country?.Guid, countries);
        retval.AddString("Observacions", selectedTel?.Obs);
        return retval;
    }
    PropertyGridModel EmailPropertyGrid()
    {
        var retval = new PropertyGridModel();
        retval.AddString("Email", selectedEmail?.EmailAddress);
        retval.AddEnum<UserModel.Rols>("Rol", selectedEmail?.Rol);
        retval.AddString("Observacions", selectedEmail?.Obs);
        retval.AddBool("Obsolet", selectedEmail?.Obsoleto);
        return retval;
    }

    void HandleTabChanged(int args)
    {
        selectedTab = (Tabs)args;
    }

    async Task HandleCloseRequest()
    {
        await CloseRequest.InvokeAsync();
    }

    async Task HandleUpdateRequestAsync()
    {
        updateState = CrudButton.States.Loading;
        try
        {
            var nif = propertyGrid!.GetString((int)Fields.Nif); // TO DO
            if (value!.Nifs.Count == 0 && !string.IsNullOrEmpty(nif))
                value.Nifs.Add(new ContactModel.Nif
                    {
                        Cod = (int)ContactModel.Nif.Cods.Nif,
                        Value = nif
                    });
            else if (value.Nifs.Count == 1 && string.IsNullOrEmpty(nif))
                value.Nifs.Clear();
            else if (value.Nifs.Count == 1 && !string.IsNullOrEmpty(nif))
                value.Nifs[0].Value = nif;
            value!.Emp = propertyGrid!.GetEmp((int)Fields.Emp);
            value.RaoSocial = propertyGrid.GetString((int)Fields.RaoSocial);
            value.NomComercial = propertyGrid.GetString((int)Fields.NomComercial);
            value.ContactClass = propertyGrid.GetGuid((int)Fields.ContactClass);
            string? adr = propertyGrid.GetString((int)Fields.Adr);
            Guid? zip = propertyGrid.GetGuid((int)Fields.Zip);
            value.Telefons = propertyGrid.GetModels<ContactModel.Telefon>((int)Fields.Tels);
            value.Emails = propertyGrid.GetModels<ContactModel.Email>((int)Fields.Emails);
            value.Obsoleto = propertyGrid.GetBool((int)Fields.Obsolet);
            if (zip != null)
            {
                value.Address = new AddressModel
                    {
                        Text = adr,
                        ZipGuid = zip,
                        Cod = AddressModel.Cods.Fiscal,
                        Contact = value.Guid
                    };
            }
            value.FullNom = ApiService.BuildContactFullNom(value);
            await ApiService.PostAsync<ContactModel, bool>(value, "Contact");
            value.IsNew = false;

            var contacts = ApiService.GetContacts();
            if (contacts?.Any(x => x.Guid == value.Guid) ?? false)
            {
                var oldValue = contacts.First(x => x.Guid == value.Guid);
                var idx = contacts.IndexOf(oldValue);
                contacts[idx] = value;
            }
            else
                contacts?.Add(value);

            contacts = contacts?.OrderBy(x => x.FullNom)?.ToList();
            await HandleCloseRequest();
            await AfterUpdate.InvokeAsync(value);
        }
        catch (Exception ex)
        {
            exception = ex;
        }
        updateState = CrudButton.States.StandBy;
    }

    async Task HandleDeleteRequestAsync()
    {
        deleteState = CrudButton.States.Loading;
        try
        {
            await ApiService.GetAsync<bool>("Contact/delete", value!.Guid.ToString());
            var contacts = ApiService.GetContacts();
            contacts?.Remove(value);
            await HandleCloseRequest();
        }
        catch (Exception ex)
        {
            exception = ex;
        }
        deleteState = CrudButton.States.StandBy;
    }

    void HandleItemChanged(PropertyGridModel.Item args)
    {
        if (args.Format == PropertyGridModel.Formats.EmpId)
        {
            value!.Emp = ((PropertyGridModel.Item<EmpModel.EmpIds>)args).Value;
            propertyGrid = PropertyGrid();
        }
    }

    void HandleTelUpdateRequest()
    {
        selectedTel!.Country= telPropertyGrid?.GetModel<CountryModel>((int)TelFields.Country);
        selectedTel.Number = telPropertyGrid?.GetString((int)TelFields.TelNum);
        selectedTel.Obs = telPropertyGrid?.GetString((int)TelFields.Obs);
        if (selectedTel.IsNew)
            value!.Telefons.Add(selectedTel);
        propertyGrid = PropertyGrid();
        selectedTel = null;
    }

    void HandleEmailUpdateRequest()
    {
        selectedEmail!.EmailAddress = emailPropertyGrid?.GetString((int)EmailFields.EmailAddress);
        selectedEmail.Rol = (UserModel.Rols?)emailPropertyGrid?.GetEnum((int)EmailFields.Rol);
        selectedEmail.Obs = emailPropertyGrid?.GetString((int)EmailFields.Obs);
        selectedEmail.Obsoleto = emailPropertyGrid?.GetBool((int)EmailFields.Obsoleto) ?? false;
        if (selectedEmail.IsNew)
            value!.Emails.Add(selectedEmail);
        propertyGrid = PropertyGrid();
        selectedEmail = null;
    }

    void AddNewLocation()
    {
        isAddingNewLocation = true;
    }

    public void Dispose()
    {
        ApiService.OnChange -= Refresca;
    }
}
