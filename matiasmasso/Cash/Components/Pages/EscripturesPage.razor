@page "/Escripturas"
@inject ApiService ApiService

<PageTitle>Cash</PageTitle>

@if (selectedItem == null)
{
    <div class="PageWrapper600">
        <h3>Escriptures</h3>

        <div class="PageOptions">
            <PageOptions>
                <LookupEmp Values="emps" Value="emp" ValueChanged="EmpChanged"></LookupEmp>
                <a href="#" @onclick="AddNew" @onclick:preventDefault>Afegir</a>
                <ToggleObsolets @bind-Value="isShowingObsolets"></ToggleObsolets>
            </PageOptions>
        </div>

        <div class="Searchbox">
            <SearchBox @bind-Value="searchterm"></SearchBox>
        </div>

        <div class="Grid">
            @foreach (var item in FilteredItems() ?? new())
            {
                <SwipeMenu Model="SwipeMenu(item)" MenuItemClick="SwipeMenuItemClickAsync">
                    <div class="Item">
                        <a class="Icon" href="@item.DownloadUrl()" target="_blank" title="clic aquí per obrir el fitxer">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 384 512">
                                <path d="M352 448V192H240c-26.5 0-48-21.5-48-48V32H64C46.3 32 32 46.3 32 64V448c0 17.7 14.3 32 32 32H320c17.7 0 32-14.3 32-32zm-.5-288c-.7-2.8-2.1-5.4-4.2-7.4L231.4 36.7c-2.1-2.1-4.6-3.5-7.4-4.2V144c0 8.8 7.2 16 16 16H351.5zM0 64C0 28.7 28.7 0 64 0H220.1c12.7 0 24.9 5.1 33.9 14.1L369.9 129.9c9 9 14.1 21.2 14.1 33.9V448c0 35.3-28.7 64-64 64H64c-35.3 0-64-28.7-64-64V64z" />
                            </svg>
                        </a>
                        <a href="#" class="Fch @(item.FchTo == null ? "" : "Baixa")"
                           title="clic aquí per obrir la fitxa"
                           @onclick="@(()=>selectedItem = item)"
                        @onclick:preventDefault>
                            <div class="Fch">@($"{item.FchFrom:dd/MM/yy}")</div>
                        </a>
                        <a href="#" class="Nom @(item.FchTo == null ? "" : "Baixa")"
                           title="clic aquí per obrir la fitxa"
                           @onclick="@(()=>selectedItem = item)"
                        @onclick:preventDefault>
                            <div class="Truncate">@item.Nom</div>
                        </a>
                    </div>
                </SwipeMenu>
            }
        </div>

    </div>
}
else
{
    <Escriptura Model="selectedItem"
                CloseRequest="@(()=> selectedItem = null)"
                AfterUpdate="AfterUpdateHandler"
                AfterDelete="AfterDeleteHandler"></Escriptura>

}
<Error @bind-Value="exception"></Error>
@code {
    [Parameter] public EventCallback CloseRequest { get; set; }
    List<EmpModel.EmpIds>? emps;
    EmpModel.EmpIds? emp;

    List<EscripturaModel>? values;
    EscripturaModel? selectedItem;
    string? searchterm;
    string? title;
    bool isShowingObsolets;
    Exception? exception;

    enum Ids
    {
        Delete,
        Browse,
        CopyUrl
    }

    protected override async Task OnParametersSetAsync()
    {
        base.OnParametersSet();

        try
        {
            values = await ApiService.GetAsync<List<EscripturaModel>>("Escripturas");
            values = values?.OrderBy(x => x.FchTo == null ? 0 : 1)
            .ThenByDescending(x => x.FchFrom)
            .ToList();
            emps = values?.Select(x => x.Emp).Distinct().ToList();
            emp = ApiService.Emp;
        }
        catch (Exception ex)
        {
            exception = ex;
        }
    }

    private List<EscripturaModel>? FilteredItems()
    {
        var retval = values?.Where(x => x.Emp == emp).ToList();
        if (!isShowingObsolets) retval = retval?.Where(x => x.FchTo == null).ToList();
        if (!string.IsNullOrEmpty(searchterm))
            retval = retval?.Where(x => x.Matches(searchterm)).ToList();
        return retval?.OrderByDescending(x=>x.FchFrom).ToList();
    }

    private SwipeMenuModel SwipeMenu(EscripturaModel value)
    {
        var retval = new SwipeMenuModel();
        var url = value.DownloadUrl();
        retval.AddDeleteButton(value);
        if (!string.IsNullOrEmpty(url))
            retval.AddBrowseButton(url);
        if (!string.IsNullOrEmpty(url))
            retval.AddCopyToClipboardButton(url);
        return retval;
    }

    private void EmpChanged(EmpModel.EmpIds args)
    {
        emp = args;
    }

    private void ItemClick(EscripturaModel item)
    {
        selectedItem = item;
    }

    private async Task SwipeMenuItemClickAsync(SwipeMenuModel.Item item)
    {
        var value = (EscripturaModel)item.Tag!;
        switch ((Ids)item.Id)
        {
            case Ids.Delete:
                try
                {
                    await ApiService.GetAsync<bool>("escriptura/delete", value.Guid.ToString());
                    values!.Remove(value);
                }
                catch (Exception ex)
                {
                    exception = ex;
                }
                break;
        }
    }

    private void AddNew()
    {
        selectedItem = new EscripturaModel
            {
                Emp = (EmpModel.EmpIds)emp!,
                FchFrom = DateOnly.FromDateTime(DateTime.Today),
                Nom = "(Nova escriptura)"
            };
    }

    private void AfterUpdateHandler(EscripturaModel args)
    {
        var idx = values!.IndexOf(values.FirstOrDefault(x => x.Guid == args.Guid));
        if (idx >= 0)
            values[idx] = args;
        else
            values!.Add(args);

        values = values.OrderBy(x => x.FchFrom).ToList();
        emps = values.Select(x => x.Emp).Distinct().ToList();
        selectedItem = null;
    }

    private void AfterDeleteHandler(EscripturaModel args)
    {
        values!.Remove(args);
        selectedItem = null;
    }


    async Task CloseRequestHandler()
    {
        await CloseRequest.InvokeAsync();
    }
}
