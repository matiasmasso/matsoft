@page "/Emps"
@inject ApiService ApiService

<PageTitle>Cash</PageTitle>

@if (values == null)
{
    <h3>Empreses</h3>
    <div>Loading...</div>
}
else if (selectedValue != null)
{
    <Emp Value="selectedValue"
         AfterUpdate="HandleAfterUpdate"
         AfterDelete="HandleAfterDelete"
         CloseRequest="@(()=>selectedValue = null)"></Emp>
}
else
{
    <div class="PageWrapper600">
        <h3>Empreses</h3>

        <div class="OptionsBar">
            <PageOptions>
                @if (ApiService.CurrentUser()?.Rol == UserModel.Rols.superUser)
                {
                    <a href="#" @onclick:preventDefault @onclick="@(()=>isShowingAll = !isShowingAll)">Tot</a>
                }
            </PageOptions>
        </div>

        <div class="Searchbox">
            <SearchBox @bind-Value="searchterm"></SearchBox>
        </div>

        <div class="Grid">

            @foreach (var item in FilteredValues() ?? new())
            {
                <a href="#"
                   class="Item @(item.FchTo == null ? "":"Grayed")"
                   @onclick="@(()=>selectedValue = item)" @onclick:preventDefault>
                    <div class="Nom">@item.AbrOrNom()</div>
                </a>
            }

        </div>
    </div>
}


<Error @bind-Value="exception"></Error>

@code {
    List<EmpModel.EmpIds>? emps;
    EmpModel.EmpIds emp;
    List<EmpModel>? values;
    EmpModel? selectedValue;
    string? searchterm;
    bool isShowingAll;
    Exception? exception;

    protected override async Task OnInitializedAsync()
    {
        base.OnInitialized();
        try
        {
            values = await ApiService.GetAsync<List<EmpModel>>("Emps");
            emps = ApiService.CurrentUser()?.Emps ?? new();
        }
        catch (Exception ex)
        {
            exception = ex;
        }
    }

    private void EmpChanged(EmpModel.EmpIds args)
    {
        emp = args;
    }

    private List<EmpModel>? FilteredValues()
    {
        var retval = isShowingAll ? values : values?.Where(x => emps!.Any(y => y == x.Id)).ToList();
        if (!string.IsNullOrEmpty(searchterm))
        {
            retval = retval?.Where(x => x.Matches(searchterm)).ToList();
        }
        return retval?.OrderBy(x => x.SortOrder())
        .ToList();
    }

    bool Belongs(EmpModel emp) => emps!.Contains(emp.Id);

    private void HandleAfterUpdate(EmpModel args)
    {
        var previous = values?.FirstOrDefault(x => x.Id == args.Id);
        if (previous == null)
            values!.Add(args);
        else
        {
            var idx = values!.IndexOf(previous);
            values[idx] = args;
        }
        values = values?.OrderBy(x => x.SortOrder()).ToList();
        selectedValue = null;
        StateHasChanged();
    }

    private void HandleAfterDelete(EmpModel args)
    {
        values!.Remove(args);
    }
}
