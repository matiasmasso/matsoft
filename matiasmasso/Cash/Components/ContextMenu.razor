@typeparam T

<div class="Wrapper" @onkeydown="@KeyHandlerTb"
     @onkeyup="@KeyHandlerTb"
    @oncontextmenu="OnContextMenuHandler"
    @oncontextmenu:preventDefault>

    @ChildContent


    @if (isShowingMenu)
    {
        <div class="Dropdown" @onfocusout="ContextMenuFocusOut" @onkeydown="OnKeyDownHandler">

            @foreach (var item in SelectedItems ?? new())
            {
                <a href="#" class="Item Selected" @onclick="@(()=>SelectedMenuItemClick(item))" @onclick:preventDefault>
                    <div class="Nom">@item.Caption</div>

                    <div class="XMark">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 384 512">
                            <!--! xMark -->
                            <path d="M326.6 166.6L349.3 144 304 98.7l-22.6 22.6L192 210.7l-89.4-89.4L80 98.7 34.7 144l22.6 22.6L146.7 256 57.4 345.4 34.7 368 80 413.3l22.6-22.6L192 301.3l89.4 89.4L304 413.3 349.3 368l-22.6-22.6L237.3 256l89.4-89.4z" />
                        </svg>
                    </div>
                </a>
            }

            @foreach (var item in DisplayItems() ?? new())
            {
                <a href="#" @onclick="@(()=>MenuItemClick(item))" class="Item" @onclick:preventDefault>
                    @item.Caption
                </a>
            }
        </div>
    }

</div>
@code {
    [Parameter] public RenderFragment? ChildContent { get; set; }

    [Parameter] public T? Tag { get; set; }
    [Parameter] public ContextMenuModel? Model { get; set; }
    [Parameter] public EventCallback<T> OnShowingMenu { get; set; }
    [Parameter] public EventCallback<ContextMenuModel.ClickEventArgs> OnClick { get; set; }
    private bool isShowingMenu;

    List<ContextMenuModel.Item> SelectedItems = new();

    List<ContextMenuModel.Item>? DisplayItems()
    {
        var parent = SelectedItems.LastOrDefault();
        var retval = Model?.Items
        .Where(x => x.Parent == parent).ToList();

        return retval;
    }

    void SelectedMenuItemClick(ContextMenuModel.Item item)
    {
        var idx = SelectedItems.IndexOf(item);
        var removeFrom = idx;
        var removeCount = SelectedItems.Count - removeFrom;
        SelectedItems.RemoveRange(removeFrom, removeCount);
    }

    void MenuItemClick(ContextMenuModel.Item item)
    {
        if (Model!.Items.Any(x => x.Parent == item))
            SelectedItems.Add(item);
        else
        {
            var args = new ContextMenuModel.ClickEventArgs
                {
                    Target = Tag,
                    Tag = item.Tag,
                    Key = item.Key,
                };
            OnClick.InvokeAsync(args);
            isShowingMenu = false;
            SelectedItems = new();
        }
    }

    private void OnContextMenuHandler()
    {
        if (!isShowingMenu)
        {
            isShowingMenu = true;
            OnShowingMenu.InvokeAsync(Tag);
        }
    }

    private void ContextMenuFocusOut()
    {
        //isShowingMenu = false;
    }

    void KeyHandlerTb(KeyboardEventArgs e)
    {
        if (e.Key == "Escape")
        {
            isShowingMenu = false;
        }
    }

    void OnKeyDownHandler(KeyboardEventArgs e)
    {
        if (e.Key == "Escape")
        {
            isShowingMenu = false;
        }
    }
}
