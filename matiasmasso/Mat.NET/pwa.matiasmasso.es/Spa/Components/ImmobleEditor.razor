@using Newtonsoft.Json
@using System.Net.Http.Json
@using DTO

@inject NavigationManager NavigationManager
@inject HttpClient Http
@inject AppState AppState

<div class="row">


    @if (DeleteDialogOpen)
{
    <ModalDialog Title="Are you sure?"
                 Text="Do you want to delete this entry?"
                 OnClose="@OnDeleteDialogClose">
    </ModalDialog>
}


    <EditForm Model="@viewModel" OnValidSubmit="@Submit">
        <DataAnnotationsValidator />
        <ValidationSummary />

        <div class="form-group">
            Nom: <InputText id="nom" @bind-Value="viewModel!.Model.Nom" class="form-control" />
        </div>

        <div class="form-group">
            Cadastre: <InputText id="obs" @bind-Value="viewModel!.Model.Cadastre" class="form-control" />
        </div>

        <Address Model=viewModel!.Model.Address ></Address>

        <br />

      <div class="Buttons">
          <!--<button type="submit" form="my-form-ref" class="btn btn-success" value="Update"/>-->
          <button type="submit" class="btn btn-success">Update</button>
          <input type="button" form="my-form-ref" class="btn btn-secondary" @onclick=Delete value="Delete"/>
          <input type="button" form="my-form-ref" class="btn btn-secondary" @onclick=Cancel value="Cancel"/>
      </div>

        <!--<button type="submit" class="btn btn-success">Update</button>-->
    </EditForm>

</div>

<br />
<br />
<a href="/Immobles">Back to List</a>


@code {
    [Parameter]
    public ImmobleDTO? Model { get; set; }

    private ImmobleViewModel? viewModel = null;
    public bool DeleteDialogOpen { get; set; } = false;

    protected override void OnParametersSet()
    {
       viewModel = new ImmobleViewModel(AppState, (ImmobleDTO)Model!);
        base.OnParametersSet();
    }


    private async Task Submit()
    {
        if (await viewModel!.Submit())
            NavigationManager.NavigateTo("Immobles");
    }

    private void Delete()
    {
        DeleteDialogOpen = true;
        StateHasChanged();
    }

    private void Cancel()
    {
        NavigationManager.NavigateTo("Immobles");
    }

    private async Task OnDeleteDialogClose(bool accepted)
    {
        DeleteDialogOpen = false;
        if(accepted)
            if (await viewModel!.Delete())
            {
                NavigationManager.NavigateTo("Immobles");
            }
        StateHasChanged();
    }

}