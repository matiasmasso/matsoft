@inject ApiService ApiService

<div class="PageWrapper600">

    <Title Value="Fitxer"></Title>

    <PropertyGrid Model="propertyGrid"
                  UpdateRequest="HandleUpdateRequest"
                  CancelRequest="HandleCloseRequest"
                  DeleteRequest="HandleDeleteRequest"
                  UpdateState="updateState"
                  DeleteState="deleteState">
    </PropertyGrid>

    <Error @bind-Value="exception"></Error>

</div>

@code {
    [Parameter] public DocfileSrcModel? Value { get; set; }
    [Parameter] public EventCallback<DocfileSrcModel> AfterUpdate { get; set; }
    [Parameter] public EventCallback<DocfileSrcModel> AfterDelete { get; set; }
    [Parameter] public EventCallback CloseRequest { get; set; }
    DocfileSrcModel? value;

    PropertyGridModel? propertyGrid;
    CrudButton.States updateState;
    CrudButton.States deleteState;

    Exception? exception;

    enum Fields
    {
        Nom,
        fch,
        Docfile
    }

    protected override void OnParametersSet()
    {
        Refresca();
        value = Value;
    }

    void Refresca(Exception? ex = null)
    {
        exception = ex;
        propertyGrid = PropertyGrid();
    }

    PropertyGridModel PropertyGrid()
    {
        var retval = new PropertyGridModel();
        retval.AddString("Nom", value?.Docfile?.Nom);
        retval.AddDateTime("Data", value?.Docfile?.Fch);
        retval.AddDocfile(value?.Docfile);
        return retval;
    }

    async Task HandleCloseRequest()
    {
        await CloseRequest.InvokeAsync();
    }


    async Task HandleUpdateRequest()
    {
        updateState = CrudButton.States.Loading;
        try
        {
            value!.Docfile = propertyGrid!.GetDocfile((int)Fields.Docfile);
            value.Docfile!.Nom = propertyGrid.GetString((int)Fields.Nom);
            value.Docfile.Fch = propertyGrid.GetDateTime((int)Fields.fch);
            await ApiService.PostMultipartAsync<DocfileSrcModel, bool>(value!.Docfile , value, "DocfileSrc");
            await AfterUpdate.InvokeAsync(value);
            await CloseRequest.InvokeAsync(value);
        }
        catch (Exception ex)
        {
            exception = ex;
        }
        updateState = CrudButton.States.StandBy;
    }

    async Task HandleDeleteRequest()
    {
        deleteState = CrudButton.States.Loading;
        try
        {
            // await ApiService.GetAsync<bool>("DocfileSrc/delete", value!.Guid.ToString());
            // await AfterDelete.InvokeAsync(value);
            // await CloseRequest.InvokeAsync(value);
        }
        catch (Exception ex)
        {
            exception = ex;
        }
        deleteState = CrudButton.States.StandBy;
    }

}
