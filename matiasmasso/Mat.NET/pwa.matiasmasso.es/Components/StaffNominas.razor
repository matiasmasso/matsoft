@inherits _Base

<div class="Wrapper">
    @if (model == null)
    {
        <Loading></Loading>
    }
    else
    {
        <div class="Summary">
            @string.Format("S'han trobat {0} fulls de nómina",model.Count())
        </div>

        <div class="Grid">
            <div class="Item ColumnHeaders HideOnMobile">
                <div>&nbsp;</div>
                <a class="Fch" href="#"
               @onclick="@(()=>SortColumn(Cols.Fch))"
               @onclick:preventDefault="true">
                    @Localizer("Fch")
                </a>
                <a class="Brut" href="#"
               @onclick="@(()=>SortColumn(Cols.Gross))"
               @onclick:preventDefault="true">
                    @Localizer("Gross")
                </a>
                <a class="Net" href="#"
               @onclick="@(()=>SortColumn(Cols.Net))"
               @onclick:preventDefault="true">
                    @Localizer("Net")
                </a>
            </div>

            <div class="GridRowDivider"></div>

            @foreach (var item in model)
            {
                <a class="Item" href="@item.PdfUrl()" target="_blank">
                    <div class="Pdf"></div>
                    <div class="Fch">@item.Fch.ToString("dd/MM/yy")</div>
                    <div class="Brut HideOnMobile">@string.Format("{0:N2} €",item.Devengat)</div>
                    <div class="Net HideOnMobile">@string.Format("{0:N2} €", item.Liquid)</div>

                    <div class="Brut HideOnDesktop">@string.Format("{0}:{1:N2} €", Localizer("Gross"),item.Devengat)</div>
                    <div class="Net HideOnDesktop">@string.Format("{0}:{1:N2} €", Localizer("Net"),item.Liquid)</div>
                </a>
                <div class="GridRowDivider"></div>
            }
        </div>
    }
</div>

<Error ProblemDetails="problemDetails"></Error>

@code {
    [Parameter] public Guid? Guid { get; set; }
    List<NominaModel>? model;
    private Cols? sortedColumn = Cols.Fch;
    private bool isDescendingOrder = false;
    private ProblemDetails? problemDetails;

    private enum Cols
    {
        Fch,
        Gross,
        Net
    }

    protected override async Task OnParametersSetAsync()
    {
        ApiResponse<List<NominaModel>> apiResponse;

        if (Guid == null)
            apiResponse = await base.GetAsync<List<NominaModel>>("staff/nominas");
        else
            apiResponse = await base.GetAsync<List<NominaModel>>("staff/nominas", Guid.ToString()!);

        model = apiResponse.Value;
        problemDetails = apiResponse.ProblemDetails;
    }


    private void SortColumn(Cols col)
    {
        var lang = base.Lang;
        if (col == sortedColumn)
            isDescendingOrder = !isDescendingOrder;
        else
            sortedColumn = col;

        switch (col)
        {
            case Cols.Fch:
                model = isDescendingOrder ? model!.OrderByDescending(x => x.Fch).ToList() : model!.OrderBy(x => x.Fch).ToList();
                break;
            case Cols.Gross:
                model = isDescendingOrder ? model!.OrderByDescending(x => x.Devengat).ToList() : model!.OrderBy(x => x.Devengat).ToList();
                break;
            case Cols.Net:
                model = isDescendingOrder ? model!.OrderByDescending(x => x.Liquid).ToList() : model!.OrderBy(x => x.Liquid).ToList();
                break;
        }
    }
}
