@inherits _Base

<div class="Wrapper">
    @if (Item != null)
    {
        if (Item.Cod == PropertyGridModel.Cods.Boolean)
        {
            <Toggle Value="(bool?)Item.Value" CanEdit="CanEdit" ObjChanged="ValueChanged"></Toggle>
        }
        else if (Item.Cod == PropertyGridModel.Cods.Fch)
        {
            <UxTextbox @bind-Value="Item.Value" @bind-Value:event="ObjChanged" ValueChanged="ValueChanged" CanEdit="CanEdit"></UxTextbox>
            @*
                <UxFch @bind-Value="Item.Value" @bind-Value:event="ObjChanged" ValueChanged="ValueChanged" CanEdit="CanEdit"></UxFch>
            *@
        }
        else if (Item.Cod == PropertyGridModel.Cods.Tel)
        {
            <UxTel @bind-Value="Item.Value" @bind-Value:event="ObjChanged" ValueChanged="ValueChanged" CanEdit="CanEdit"></UxTel>
        }
        else if (Item.Cod == PropertyGridModel.Cods.Email)
        {
            <a class="Email" href="#" @onclick="ItemClickAsync" @onclick:preventDefault>
                @(((UserModel?)Item.Value)?.EmailAddress)
            </a>

            @*
                <ContextMenuTrigger MenuId="MenuEmail" Data="Item.Value">
                <UxEmail @bind-Value="Item.Value" @bind-Value:event="ObjChanged" ValueChanged="ValueChanged" CanEdit="false"></UxEmail>
                </ContextMenuTrigger>
            *@
        }
        else if (Item.Cod == PropertyGridModel.Cods.Password)
        {
            <UxPassword @bind-Value="Item.Value" @bind-Value:event="ObjChanged" CanEdit="CanEdit"></UxPassword>
        }
        else if (Item.Cod == PropertyGridModel.Cods.Iban)
        {
            <UxIban Value="(IbanModel)Item.Value" ObjChanged="ValueChanged"></UxIban>
        }
        else if (Item.Cod == PropertyGridModel.Cods.Dropdown)
        {
            <Dropdown Values="Item.Values"
              Value="(IModel?)Item.Value"
              ValueChanged="DropdownChanged"
              CanEdit="CanEdit"></Dropdown>
            @*ContextMenu="Item.ContextMenu"*@
        }
        else if (Item.Cod == PropertyGridModel.Cods.Multiline)
        {
            <UxTextarea @bind-Value="Item.Value" @bind-Value:event="ObjChanged" ValueChanged="ValueChanged" CanEdit="CanEdit"></UxTextarea>
        }
        else
        {
            <UxTextbox @bind-Value="Item.Value" @bind-Value:event="ObjChanged" ValueChanged="ValueChanged" CanEdit="CanEdit"></UxTextbox>
        }
    }

</div>

<ContextMenu Id="MenuEmail">
    <Item Key="LoginAs" OnClick="@ContextMenuClickAsync">Loggeja'l</Item>
    <Item Key="Message" OnClick="@ContextMenuClickAsync">Missatge</Item>
</ContextMenu>


@code {

    [Parameter] public bool CanEdit { get; set; }
    [Parameter] public bool IsDirty { get; set; }
    [Parameter] public int? MaxLength { get; set; }
    [Parameter] public EventCallback<PropertyGridModel.Item> SetDirty { get; set; }
    [Parameter] public EventCallback<PropertyGridModel.Item> RequestToAddNew { get; set; }
    [Parameter] public EventCallback<ItemClickEventArgs> ContextMenuClick { get; set; }
    [Parameter] public EventCallback<PropertyGridModel.Item> ItemClick { get; set; }
    [Parameter] public PropertyGridModel.Item Item { get; set; }

    private bool isEditing = false;
    private bool isShowingSelector = false;

    private void ValueClicked()
    {
        if (Item!.Cod == PropertyGridModel.Cods.Dropdown)
        {
            isShowingSelector = true;
            isEditing = true;
        }
        else if (Item!.Cod == PropertyGridModel.Cods.Boolean)
        {
            if ((bool)(Item.Value ?? false))
            {
                Item!.Value = false;
                Item.Id = "False";
                Item.DisplayText = Item.Id;
            }
            else
            {
                Item!.Value = true;
                Item.Id = "True";
                Item.DisplayText = Item.Id;
            }
        }
        else
        {
            isEditing = true;
        }
    }


    private void DropdownChanged(object args)
    {
        Item.Value = args;
        SetDirty.InvokeAsync(Item);
        isEditing = false;
        isShowingSelector = false;
    }

    private void ValueChanged(object args)
    {
        Item.Value = args;
        SetDirty.InvokeAsync(Item);
    }

    private void AddNewRequest()
    {
        RequestToAddNew.InvokeAsync(Item);
    }

    async Task ContextMenuClickAsync(ItemClickEventArgs e)
    {
        await ContextMenuClick.InvokeAsync(e);
    }

    async Task ItemClickAsync()
    {
        await ItemClick.InvokeAsync(Item);
    }

    //async Task MenuItemClick(ItemClickEventArgs e)
    //{
    //    var item = (ShoppingBasketModel)e.Data;
    //    var key = e.MenuItem.Attributes["Key"].ToString();
    //    switch (key)
    //    {
    //        case "Message":
    //            break;
    //        case "LoginAs":
    //            var apiResponse = await base.GetAsync<bool>("ShoppingBasket/delete", item.Guid.ToString());
    //            if (apiResponse.Success())
    //                items!.Remove(item);
    //            else
    //                problemDetails = apiResponse.ProblemDetails;
    //            break;
    //    }
    //    Console.WriteLine($"Item Clicked => Menu: {e.ContextMenuId}, MenuTarget: {e.ContextMenuTargetId}, IsCanceled: {e.IsCanceled}, MenuItem: {e.MenuItemElement}, MouseEvent: {e.MouseEvent}");
    //}

}
