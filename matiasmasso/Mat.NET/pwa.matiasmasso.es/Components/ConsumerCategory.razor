@inherits _Base

@if (model == null)
{
    <Loading></Loading>
}
else
{
    <div class="Wrapper">
        <div class="Breadcrumbs">
            <Breadcrumbs Model="breadcrumbs"></Breadcrumbs>
        </div>

        <div class="Content">
            @if (model?.Content?.Length<50)
            {
                <SkusGallery Model="@Skus()"></SkusGallery>
            }
            else
            {
                @(model?.Content == null ? null : (MarkupString)model.Content)
            }
        </div>

        <a id="StoreLocator">linked here</a>
            <StoreLocator Model="model.StoreLocator"></StoreLocator>

        <Error ProblemDetails="problemDetails"></Error>
    </div>
}

@code {
    [Parameter] public Guid Guid { get; set; }
    private List<Box> breadcrumbs = new();
    private string? content;
    private ProductLandingPageDTO? model;
    private ProblemDetails? problemDetails;



    protected override async Task OnParametersSetAsync()
    {
        if (model == null)
        {
            var apiResponse = await GetAsync<ProductLandingPageDTO>("ProductLandingPage", Guid.ToString());
            if (apiResponse.Success())
            {
                model = apiResponse.Value;
                breadcrumbs = model!.Breadcrumbs(Cache!, base.Lang());
            }
            else
                problemDetails = apiResponse.ProblemDetails;
        }
    }

    private List<ProductSkuModel>Skus() {
        return Cache!.Skus
        .Where(x => x.Category == Guid && x.Obsoleto == false )
        .OrderBy(x => x.Nom?.Tradueix(base.Lang()) ?? "")
        .ToList();
    }

}
