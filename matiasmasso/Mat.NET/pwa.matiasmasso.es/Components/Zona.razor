@inherits _Base

<PropertyGrid model="@gridModel"></PropertyGrid>

<Error ProblemDetails="problemDetails"></Error>

@code {
    [Parameter] public Guid? Guid { get; set; }
    [Parameter] public EventCallback AfterUpdate { get; set; }
    [Parameter] public EventCallback RequestToCancel { get; set; }
    private ZonaModel? value;
    private PropertyGridModel? gridModel;
    private AtlasModel? atlas;
    ProblemDetails? problemDetails;

    private enum Fields : int
    {
        Country,
        ISO,
        Nom,
        Provincia,
        Lang,
        ExportCod,
        Mod347
    }

    protected async override Task OnParametersSetAsync()
    {
        if (Guid != null)
        {
            var apiResponse = await GetAsync<ZonaModel>("Zona", Guid.ToString()!);
            if (apiResponse.Value != null)
            {
                value = apiResponse.Value;
                var model = new PropertyGridModel(value);
                model.AddDropdown<GuidNom>((int)Fields.Country, Cache!.CountriesGuidNoms(base.Lang()), Cache!.Country(value.Country)?.ToGuidNom(base.Lang()), Localizer("Country"));
                model.AddString((int)Fields.ISO, value.ISO, "ISO"); //https://service.unece.org/trade/locode/2022-1%20SubdivisionCodes.htm
                model.AddString((int)Fields.Nom, value.Nom, Localizer("Name"));
                model.AddDropdown<ProvinciaModel>((int)Fields.Provincia, Cache.CountryProvincias(value.Country), Cache.Provincia(value.Provincia), Localizer("Province"));
                //model.AddDropdown<LangDTO>((int)Fields.Lang, LangDTO.All(), Lang(), Localizer("Lang"));
                //model.AddEnum((int)Fields.ExportCod, value.ExportCod, ((int)value.ExportCod!).ToString(), ((CountryModel.ExportCods)(value.ExportCod)).ToString(), "Cod.Exportación", "Cod.Exportació", "Export code");
                model.AddBool((int)Fields.Mod347, value.Mod347, "Mod.347");
                gridModel = model;
                StateHasChanged();
            }
            else
            {
                problemDetails = apiResponse.ProblemDetails;
            }

        }
    }


    private async Task SaveRequest()
    {
        value!.Country = (Guid)gridModel!.GetModelGuid((int)Fields.Country);
        value!.ISO = gridModel!.GetString( (int)Fields.ISO);
        value!.Nom = gridModel!.GetString((int)Fields.Nom);
        value!.Provincia = (Guid)gridModel!.GetModelGuid((int)Fields.Provincia);
        //value!.Lang = LangDTO.Factory(gridModel!.GetString((int)Fields.Lang));
        //value!.ExportCod = (DTO.ZonaModel.ExportCods)gridModel!.Items.FirstOrDefault(x => x.Field == (int)Fields.ExportCod)?.Value;
        value!.Mod347 = gridModel!.GetBool((int)Fields.Mod347);

        var apiResponse = await PostAsync<ZonaModel, bool>(value, "Zona");
        if (apiResponse.Success())
            CancelRequest();
        else
            problemDetails = apiResponse.ProblemDetails;
    }

    private async Task DeleteRequest()
    {
        var apiResponse = await GetAsync<ZonaModel>("Zona/delete", value!.Guid.ToString());
        if (apiResponse.Success())
        {
            Cache!.Zonas.Remove(value);
            CancelRequest();
        }
        else
            problemDetails = apiResponse.ProblemDetails;
    }

    private void CancelRequest()
    {
        if (RequestToCancel.HasDelegate)
            RequestToCancel.InvokeAsync();
    }
}
