@inherits _Base

<div class="PageWrapper">

    <a class="CloseButton" href="#" @onclick="RequestToClose" @onclick:preventDefault>
        [@Localizer("Close")]
    </a>

    @if (Model == null)
    {
        <Loading >
        </Loading>
    }
    else
    {

        <TabControl>
            <TabPage Text="@Localizer("Details")">
                <ChildContent>

                    <div class="Truncate">
                        @Localizer("OrderIdFromFch",Model.Id.ToString(),string.Format("{0:dd/MM/yy}",Model.Fch))
                    </div>
                    <div class="Truncate">
                        @Model.Contact?.Nom
                    </div>
                    <div class="Truncate">
                        @Model.Concept
                    </div>
                    <div class="UsrLog Truncate">
                        @Model.UsrLog?.Caption(base.Lang())
                    </div>

                    <div class="Grid">
                        @foreach (var item in ControlItems)
                        {
                            <div class="Item">
                                <div class="Thumbnail">
                                    <UxImg Src="@item.ThumbnailUrl" />
                                </div>
                                <div>
                                    <div class="Truncate">
                                        @item.BrandNom
                                    </div>
                                    @if (!string.IsNullOrEmpty(item.DeptNom))
                                    {
                                        <div class="Truncate">
                                            @item.DeptNom
                                        </div>
                                    }
                                    <div class="Truncate">
                                        @item.CategoryNom
                                    </div>
                                    <div class="Truncate">
                                        @item.SkuNom
                                    </div>
                                    <div class="Amount">
                                        @item.Amount
                                    </div>
                                </div>
                            </div>

                        }

                    </div>
                </ChildContent>
            </TabPage>

            <TabPage Text="@Localizer("Document")">
                <ChildContent>
                    <Docfile model="@(new DocFileModel(Model.Hash ?? ""))"></Docfile>
                </ChildContent>
            </TabPage>
        </TabControl>

    }

</div>

<Error ProblemDetails="problemDetails"></Error>


@code {
    [Parameter] public Guid Guid { get; set; }
    [Parameter] public EventCallback CloseRequest { get; set; }
    
    private PurchaseOrderModel? Model { get; set; }
    private List<ControlItem> ControlItems = new();
    private ProblemDetails? problemDetails;

    protected override async Task OnParametersSetAsync()
    {
        var apiResponse = await GetAsync<PurchaseOrderModel>("purchaseOrder", Guid.ToString());
        if (apiResponse.Value!= null)
        {
            Model = apiResponse.Value;
            ControlItems = Model.Items.Select(x => new ControlItem(x, Cache!, base.Lang())).ToList();
        }
        else
            problemDetails = apiResponse.ProblemDetails;

        StateHasChanged();
    }

    private void RequestToClose()
    {
        CloseRequest.InvokeAsync();
    }

    public class ControlItem
    {
        public string? ThumbnailUrl { get; set; }
        public string? BrandNom { get; set; }
        public string? DeptNom { get; set; }
        public string? CategoryNom { get; set; }
        public string? SkuNom { get; set; }
        public string? Amount { get; set; }
        public ProductSkuModel? Sku { get; set; }
        public ProductCategoryModel? Category { get; set; }
        public ProductDeptModel? Dept { get; set; }
        public ProductBrandModel? Brand { get; set; }

        public ControlItem(PurchaseOrderModel.Item item, CacheDTO cache, LangDTO lang)
        {
            ThumbnailUrl = Globals.ApiUrl("productSku/thumbnail", item.Sku.ToString() + ".jpg");
            Sku = cache.Sku(item.Sku);
            if (Sku != null)
            {
                SkuNom = Sku.Nom?.Tradueix(lang) ?? "sku?";
                Category = cache.Category(Sku.Category);
                if (Category != null)
                {
                    CategoryNom = Category.Nom?.Tradueix(lang) ?? "category?";
                    //if (Category.Dept != null)
                    //{
                    //    Dept = cache.Dept((Guid)Category.Dept!);
                    //    if (Dept != null)
                    //        DeptNom = Dept.Nom.Tradueix(lang) ?? "dept?";
                    //}

                    Brand = cache.Brand(Category.Brand);
                    if (Brand != null)
                        BrandNom = Brand.Nom?.Tradueix(lang) ?? "brand?";
                }
            }

            if (item.Dto == 0)
            {
                Amount = string.Format("{0} x {1:N2}€ = {2:N2}€", item.Qty, item.Price, item.Amt());
            }
            else
            {
                Amount = string.Format("{0} x {1:N2}€ - {2}% = {3:N2}€", item.Qty, item.Price, item.Dto, item.Amt());
            }
        }
    }
}

