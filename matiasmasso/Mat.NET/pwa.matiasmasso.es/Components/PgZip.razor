@inherits _Base

<PropertyGrid model="@gridModel"
              RequestToUpdate="SaveRequest"
              RequestToDelete="DeleteRequest"
              RequestToCancel="CancelRequest"
              ErrorMessage="@errorMessage"
              GetOptions="GetOptions"></PropertyGrid>


<Error ProblemDetails="problemDetails"></Error>

@code {
    [Parameter] public Guid? Guid { get; set; }
    [Parameter] public EventCallback AfterUpdate { get; set; }
    [Parameter] public EventCallback RequestToCancel { get; set; }
    private ZipModel? value;
    private PropertyGridModel? gridModel;
    private AtlasModel? atlas;
    private string? errorMessage;
    ProblemDetails? problemDetails;

    private enum Fields : int
    {
        Location,
        ZipCod
    }

    protected async override Task OnParametersSetAsync()
    {
        if (Guid != null)
        {
            //atlas = await base.Atlas();
            //value = atlas.Zip((Guid)Guid);
            //if (value != null)
            //{
            //    //var model = new PropertyGridModel();
            //    //model.AddEnum((int)Fields.Location, value.Location, value.Location.ToString(), atlas.Location(value.Location)?.Nom, "Población", "Població", "Location");
            //    //model.AddString((int)Fields.ZipCod,value.ZipCod,"Código postal", "Codi postal", "Zip code");
            //    //gridModel = model;
            //    //StateHasChanged();
            //}
        }
    }


    private async Task SaveRequest()
    {
        value!.Location = (Guid)gridModel!.Items.FirstOrDefault(x => x.Field == (int)Fields.Location)?.Value;
        value!.ZipCod = gridModel!.Items.FirstOrDefault(x => x.Field == (int)Fields.ZipCod)?.Value?.ToString();

        var apiResponse = await PostAsync<ZipModel, bool>( value, "Zip");
        if (apiResponse.Success())
            CancelRequest();
        else
            problemDetails = apiResponse.ProblemDetails;
    }

    private async Task DeleteRequest()
    {
        var apiResponse = await GetAsync<ZipModel>( "Zip/delete", value!.Guid.ToString());
        if (apiResponse.Success())
        {
            Cache.Zips.Remove(value);
            CancelRequest();
        }
        else
            problemDetails = apiResponse.ProblemDetails;
    }

    private void CancelRequest()
    {
        if (RequestToCancel.HasDelegate)
            RequestToCancel.InvokeAsync();
    }

    public async Task<List<Option>> GetOptions(PropertyGridModel.Item item)
    {
        List<Option> retval = new();
        if (item.Field == (int)Fields.Location)
        {
            retval = atlas!.Locations
            .Select(x => new Option
                {
                    Id = x.Guid.ToString(),
                    Nom = x.Nom ?? "?",
                    Tag = x.Guid
                }).ToList();
        }

        return retval;
    }
}
