@inject CultureService culture
@inject ContactsService contactsService

<div class="PageWrapper600">

    @if (Model == null)
    {
        <Loading></Loading>
    }
    else
    {
        <h3>@Model?.FullNom</h3>

        <TabControl>
            <TabPage Text="@culture.Localize("General")">
                <PropertyGrid Model="@gridModel"
                              SetDirty="@(()=>state = DbState.IsDirty)"
                              CanEdit="true"></PropertyGrid>

                              <div class="Emails">
                @foreach(var email in value?.Emails ?? new())
                {
                        <a href="#" @onclick="@(()=>EmailClick(email))" @onclick:preventDefault>
                        @email.EmailAddress
                    </a>
                }
                </div>

                <div class="ButtonsBar">
                    <ButtonsBar CanEdit="true"
                                State="state"
                                CanDelete="@(!(value?.IsNew ?? false))"
                                RequestToCancel="CancelRequest"
                                RequestToDelete="DeleteRequest"
                                RequestToUpdate="UpdateAsync"></ButtonsBar>
                </div>

            </TabPage>
        </TabControl>
    }

</div>

<Error @bind-Exception="exception"></Error>

@code {
    [Parameter] public ContactModel? Model { get; set; }
    [Parameter] public EventCallback<ModelEditor.Breadcrumb> EditorRequest { get; set; }
    [Parameter] public EventCallback RequestToCancel { get; set; }

    ContactModel? value;
    PropertyGridModel? gridModel;
    DbState state;
    Exception? exception;

    enum Fields
    {
        RaoSocial,
        Nif
    }

    protected override async Task OnParametersSetAsync()
    {
        value = await contactsService.FetchAsync(Model?.Guid);
        gridModel = new PropertyGridModel(value);
        gridModel.AddString((int)Fields.RaoSocial, value?.RaoSocial, culture.Localize("RaoSocial"));
        gridModel.AddString((int)Fields.Nif, value?.Nifs.FirstOrDefault()?.Value, culture.Localize("Nif"));
    }



    void CancelRequest()
    {
        RequestToCancel.InvokeAsync();
    }

    async Task UpdateAsync()
    {
        try
        {
            value!.RaoSocial = gridModel!.GetString((int)Fields.RaoSocial);
            await contactsService.UpdateAsync(value);
            CancelRequest();
        }
        catch (Exception ex)
        {
            exception = ex;
        }
    }

    void DeleteRequest()
    {
        try
        {

        }
        catch (Exception ex)
        {
            exception = ex;
        }
    }

    async Task EmailClick(UserModel item)
    {
        var breadcrumb = new ModelEditor.Breadcrumb(item, item.EmailAddress ?? "email?");
        await EditorRequest.InvokeAsync(breadcrumb);
    }

}
