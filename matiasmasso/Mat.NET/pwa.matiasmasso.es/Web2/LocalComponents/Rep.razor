@inject CultureService culture
@inject RepsService RepsService

<h1>
    @Model?.AbrOrNom()
</h1>

<TabControl>
    <TabPage Text="@culture.Localize("Properties")">

        @if (Model == null)
        {
            <Loading></Loading>
        }
        else
        {
            <PropertyGrid model="@gridModel"
                          SetDirty="@(()=>state = DbState.IsDirty)"
                          CanEdit="@true"></PropertyGrid>

            <div class="ButtonsBar">
                <ButtonsBar CanEdit="@true"
                            State="state"
                            CanDelete="@(!(Model?.IsNew ?? false))"
                            RequestToCancel="CancelRequest"
                            RequestToUpdate="UpdateRequest"></ButtonsBar>
            </div>
        }


    </TabPage>

</TabControl>

<Error @bind-Exception="exception"></Error>

@code {
    [Parameter] public RepModel? Model { get; set; }
    [Parameter] public EventCallback RequestToCancel { get; set; }
    private PropertyGridModel? gridModel;
    private DbState state;
    private Exception? exception;

    private enum Fields : int
    {
        Nom,
        Abr,
        Nif,
        Address,
        FchFrom,
        FchTo,
        Iban,
        Tel,
        Email
    }

    protected async override Task OnParametersSetAsync()
    {
        try
        {
            if (Model != null) Model = await RepsService.FindAsync(Model.Guid);
        }
        catch (Exception ex)
        {
            exception = ex;
        }

        gridModel = new PropertyGridModel(Model);
        gridModel.AddString((int)Fields.Nom, Model?.Nom, culture.Localize("Name"));
        gridModel.AddString((int)Fields.Abr, Model?.Abr, culture.Localize("Alias"));
        gridModel.AddString((int)Fields.Nif, Model?.Nif, culture.Localize("Vat"));
        //gridModel.AddEnum((int)Fields.Position, Model.Position, Model.Position?.Guid.ToString(), Model.Position?.Nom.Tradueix(base.Lang()), "Cargo", "Carrec", "Position");
        gridModel.AddAddress((int)Fields.Address, Model?.Address, culture.Localize("Address"));
        gridModel.AddFch((int)Fields.FchFrom, Model?.FchFrom, culture.Localize("EntryDate"));
        gridModel.AddFch((int)Fields.FchTo, Model?.FchTo, culture.Localize("TerminationDate"));
        gridModel.AddIban((int)Fields.Iban, Model?.Iban);
        foreach (var tel in Model?.Telefons ?? new())
        {
            //gridModel.AddTel((int)Fields.Tel, tel);
        }
        foreach (var email in Model?.Emails ?? new())
        {
            //gridModel.AddEmail((int)Fields.Email, email);
        }
        StateHasChanged();
    }


    private async Task UpdateRequest()
    {
        var cc = new System.Globalization.CultureInfo("es-ES");
        Model!.Nom = gridModel!.GetString((int)Fields.Nom);
        Model!.Abr = gridModel!.GetString((int)Fields.Abr);
        Model!.FchFrom = gridModel!.GetValue<DateTime?>((int)Fields.FchFrom);
        Model!.FchTo = gridModel!.GetValue<DateTime?>((int)Fields.FchTo);
        Model!.Iban = gridModel!.GetValue<IbanModel?>((int)Fields.Iban);

        try
        {
            await RepsService.UpdateAsync(Model);
            CancelRequest();
        }
        catch (Exception ex)
        {
            exception = ex;
        }
    }

    private async Task DeleteRequest()
    {
        try
        {
            await RepsService.DeleteAsync(Model);
            CancelRequest();
        }
        catch (Exception ex)
        {
            exception = ex;
        }
    }

    private void CancelRequest()
    {
        if (RequestToCancel.HasDelegate)
            RequestToCancel.InvokeAsync();
    }

}

