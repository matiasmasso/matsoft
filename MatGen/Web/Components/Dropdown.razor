@typeparam GenericType
@using System.Globalization

<div class="Wrapper" @oncontextmenu="ContextMenuCall" @oncontextmenu:preventDefault>
    @if (isExpanded && Values.Count > 5)
    {

        <input type="text" value="@searchterm" @oninput="SearchChanged" @onkeypress="@KeyHandlerTb" @onkeydown="@KeyHandlerTb" />
        <div class="Lupa">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512">
                <path d="M368 208A160 160 0 1 0 48 208a160 160 0 1 0 320 0zM337.1 371.1C301.7 399.2 256.8 416 208 416C93.1 416 0 322.9 0 208S93.1 0 208 0S416 93.1 416 208c0 48.8-16.8 93.7-44.9 129.1l124 124 17 17L478.1 512l-17-17-124-124z" />
            </svg>
        </div>
    }
    else
    {
        <div class="Caption" @onclick="Expand">
            @if (Value == null)
            {
                <span>(select)</span>
            }
            else
            {
                <a href="#" title="@AnchorTitle" @onclick="CaptionClick" @onclick:preventDefault style="color:@fontColor">
                    @Value?.ToString()
                </a>
            }
            <div class="Chevron">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512">
                    <path d="M432.6 209.3l-191.1 183.1C235.1 397.8 229.1 400 224 400s-11.97-2.219-16.59-6.688L15.41 209.3C5.814 200.2 5.502 184.1 14.69 175.4c9.125-9.625 24.38-9.938 33.91-.7187L224 342.8l175.4-168c9.5-9.219 24.78-8.906 33.91 .7187C442.5 184.1 442.2 200.2 432.6 209.3z" />
                </svg>
            </div>
        </div>
    }


    <div class="Dropdown @(isExpanded ? "" : "Hidden" )">
        <Virtualize Items="FilteredValues()" Context="item">
            @if (IsSelected(item))
            {
                <div class="Item Active">
                    @item?.ToString()
                </div>
            }
            else
            {
                <a href="#" class="Item" title="@GetTitle(item)"
                @onclick="@(()=>ItemClick(item))"
                @onclick:preventDefault>
                    @item?.ToString()
                </a>
            }
        </Virtualize>
    </div>


        <div class="Dropdown ContextMenu @(isShowingMenu ? "Active" : "")">
            @if (Value != null)
            {
                <a href="#" @onclick="CaptionClick" @onclick:preventDefault>
                    Zoom
                </a>
                <a href="#" @onclick="Clear" @onclick:preventDefault>
                    Clear
                </a>
            }
            <a href="#" @onclick="AddNew" @onclick:preventDefault>
                Afegir
            </a>
        </div>
</div>

@code {
    [Parameter] public GenericType? Value { get; set; }
    [Parameter] public List<GenericType> Values { get; set; } = new();
    [Parameter] public EventCallback<GenericType> ValueChanged { get; set; }
    [Parameter] public EventCallback<GenericType> OnClick { get; set; }
    [Parameter] public EventCallback RequestToAddNew { get; set; }
    [Parameter] public string FontColor { get; set; } = Colors.Black;

    bool isExpanded;
    bool isShowingMenu;
    private string? searchterm;
    private string? fontColor;

    protected override void OnParametersSet(){
        base.OnParametersSet();
        fontColor = FontColor;
    }

    List<GenericType> FilteredValues()
    {
        List<GenericType>? retval;
        if (string.IsNullOrEmpty(searchterm))
            retval = Values;
        else
        {
            var searchTerms = searchterm.Split("+", StringSplitOptions.RemoveEmptyEntries);
            var compareInfo = CultureInfo.InvariantCulture.CompareInfo;
            var options = CompareOptions.IgnoreCase | CompareOptions.IgnoreSymbols | CompareOptions.IgnoreNonSpace;

            retval = Values?.Where(x => searchTerms.All(y => compareInfo.IndexOf(x?.ToString() ?? "", y, options) >= 0)).ToList();
        }
        //retval = Values?.Where(x => x.ToString()?.Contains(searchterm, StringComparison.CurrentCultureIgnoreCase) ?? false).ToList();
        return retval ?? new();
    }

    bool IsSelected(GenericType item) => EqualityComparer<GenericType>.Default.Equals(Value, item);

    public void ItemClick(GenericType item)
    {
        isExpanded = false;
        searchterm = string.Empty;
        if (ValueChanged.HasDelegate)
        {
            ValueChanged.InvokeAsync(item);
        }
    }

    private string? GetTitle(GenericType item)
    {
        if (item is PersonModel person)
        {
            return person.FullNom2();
        }
        return item?.ToString();
    }

    private void SearchChanged(ChangeEventArgs args)
    {
        searchterm = args.Value?.ToString();
    }

    private void Expand()
    {
        if (isExpanded)
        {
            isExpanded = false;
            searchterm = string.Empty;
        }
        else
        {
            isExpanded = true;
        }
    }

    private void ContextMenuCall()
    {
        isShowingMenu = true;
    }

    private void CaptionClick()
    {
        OnClick.InvokeAsync();
        isShowingMenu = false;
    }

    private void Clear()
    {
        if (ValueChanged.HasDelegate)
        {
            ValueChanged.InvokeAsync(default(GenericType));
        }
        isShowingMenu = false;
    }

    void KeyHandlerTb(KeyboardEventArgs e)
    {
        if (e.Key == "Escape")
        {
            isExpanded = false;
            isShowingMenu = false;
            searchterm = string.Empty;
        }
    }

    void AddNew()
    {
        RequestToAddNew.InvokeAsync();
        isShowingMenu = false;
    }

    string? AnchorTitle => Value is PersonModel person ? person.FullNom2() : Value?.ToString();

}
