@using Identity.DTO

@if (User is null)
{
    <p class="text-muted">Selecciona un usuari per veure les aplicacions.</p>
}
else
{
    <h5>Aplicacions de @User.Email</h5>

    <ul class="list-group">
        @foreach (var app in Applications)
        {
            var enrolled = User.Applications.Any(a => a.ApplicationId == app.ApplicationId);

            <li class="list-group-item d-flex justify-content-between align-items-center
                                   @(app.ApplicationId == SelectedAppId ? "active" : "")"
                @onclick="() => SelectApplication(app.ApplicationId!.Value)">

                <span>@app.Name</span>

                <input type="checkbox"
                       checked="@enrolled"
                       @onclick:stopPropagation="true"
                       disabled="@isBusy"
                       @onchange="e => Toggle(app.ApplicationId!.Value, (bool)e.Value!)" />
            </li>
        }
    </ul>
}

@code {
    [Parameter] public UserDto? User { get; set; }
    [Parameter] public List<ApplicationDto> Applications { get; set; } = new();
    [Parameter] public Guid SelectedAppId { get; set; }
    [Parameter] public UsersApi UsersApi { get; set; } = default!;

    // Parent handles selection
    [Parameter] public EventCallback<Guid> OnAppSelected { get; set; }

    // Parent handles enrollment changes
    [Parameter] public EventCallback<(Guid AppId, bool Enroll)> OnToggleApp { get; set; }

    private bool isBusy = false;

    private async Task SelectApplication(Guid appId)
    {
        if (OnAppSelected.HasDelegate)
            await OnAppSelected.InvokeAsync(appId);
    }

    private async Task Toggle(Guid appId, bool enroll)
    {
        if (User is null || isBusy)
            return;

        isBusy = true;

        // Call API
        if (enroll)
            await UsersApi.EnrollUserAsync(User.Id, appId);
        else
            await UsersApi.UnenrollUserAsync(User.Id, appId);

        // Notify parent to update the cloned model
        if (OnToggleApp.HasDelegate)
            await OnToggleApp.InvokeAsync((appId, enroll));

        isBusy = false;
        StateHasChanged();
    }
}