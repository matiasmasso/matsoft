@using System.ComponentModel.DataAnnotations
@using Microsoft.AspNetCore.Components.Forms
@using Microsoft.JSInterop

@namespace MatComponents.PropertyGrid


<EditForm EditContext="_editContext">
    <CascadingValue Value="_editContext">
        <div class="mat-propertygrid-container">

            @if (_categories != null)
            {
                @foreach (var cat in _categories)
                {
                    <div class="mat-propertygrid-category-header" @onclick="() => Toggle(cat)">
                        <span class="mat-propertygrid-category-arrow">
                            @(cat.Expanded ? "▼" : "▶")
                        </span>
                        <span class="mat-propertygrid-category-title">@cat.Name</span>
                    </div>

                    @if (cat.Expanded)
                    {
                        @foreach (var meta in cat.Properties)
                        {
                            <div class="mat-propertygrid-row">
                                <div class="mat-propertygrid-label">@meta.Label</div>
                                <div class="mat-propertygrid-splitter"></div>

                                <div class="mat-propertygrid-editor @(
                                     _editContext.IsModified(meta.Field) &&
                                     _editContext.GetValidationMessages(meta.Field).Any()
                                         ? "invalid"
                                         : ""
                                        )">
                                    @EditorFactory.Render(meta, SelectedObject, meta.Field)
                                    <PgValidationMessage Field="meta.Field" />
                                </div>
                            </div>
                        }
                    }
                }
            }

        </div>
    </CascadingValue>
</EditForm>

@code {
    //[Parameter] public object Model { get; set; }
    [CascadingParameter] public EditContext CascadedEditContext { get; set; }
    [Parameter] public object? SelectedObject { get; set; }
    [Parameter] public EventCallback<object?> OnObjectChanged { get; set; }
    [Parameter] public PropertyGridOptions? Options { get; set; }

    //Recommended JS structure for your PropertyGrid
    [Inject] private IJSRuntime JS { get; set; } = default!;

    private EditContext _editContext;
    private ValidationMessageStore _messages;
    private List<CategoryModel> _categories;

    protected override void OnParametersSet()
    {
        if (SelectedObject == null)
            return;

        var opts = Options ?? new PropertyGridOptions();

        if (CascadedEditContext != null)
        {
            // Som un PropertyGrid nested → reutilitzem l’EditContext existent
            if (_editContext != CascadedEditContext)
            {
                _editContext = CascadedEditContext;
                _messages = new ValidationMessageStore(_editContext);

                _editContext.OnFieldChanged -= HandleFieldChanged;
                _editContext.OnFieldChanged += HandleFieldChanged;

                _editContext.OnValidationStateChanged -= OnValidationStateChanged;
                _editContext.OnValidationStateChanged += OnValidationStateChanged;
            }
        }
        else
        {
            // Som el root → creem l’EditContext
            if (_editContext == null || _editContext.Model != SelectedObject)
            {
                _editContext = new EditContext(SelectedObject);
                _messages = new ValidationMessageStore(_editContext);

                _editContext.OnFieldChanged -= HandleFieldChanged;
                _editContext.OnFieldChanged += HandleFieldChanged;

                _editContext.OnValidationStateChanged -= OnValidationStateChanged;
                _editContext.OnValidationStateChanged += OnValidationStateChanged;
            }
        }

        LoadCategories();
    }

    private void HandleFieldChanged(object sender, FieldChangedEventArgs e)
    {
        var field = e.FieldIdentifier;

        _messages.Clear(field);

        var property = field.Model.GetType().GetProperty(field.FieldName);
        var value = property?.GetValue(field.Model);

        var results = new List<ValidationResult>();
        var context = new ValidationContext(field.Model)
        {
            MemberName = field.FieldName
        };

        if (!Validator.TryValidateProperty(value, context, results))
        {
            foreach (var result in results)
                _messages.Add(field, result.ErrorMessage);
        }

        _editContext.NotifyValidationStateChanged();
    }

    private void OnValidationStateChanged(object sender, ValidationStateChangedEventArgs e)
    {
        InvokeAsync(StateHasChanged);
    }

    private void LoadCategories()
    {
        var props = ReflectionHelpers.GetMetadata(SelectedObject);

        foreach (var meta in props)
            meta.Field = new FieldIdentifier(SelectedObject, meta.Property.Name);

        _categories = props
            .GroupBy(p => p.Category)
            .Select(g => new CategoryModel
            {
                Name = g.Key,
                Expanded = true,
                Properties = g.OrderBy(p => p.Order).ToList()
            })
            .OrderBy(c => c.Name)
            .ToList();
    }

    private void Toggle(CategoryModel cat)
        => cat.Expanded = !cat.Expanded;



}