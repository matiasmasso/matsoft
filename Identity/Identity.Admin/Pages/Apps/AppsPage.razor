@page "/apps"
@using Identity.Admin.Components.Apps
@inject IAppsService AppsService
@inject ToastService Toasts
@inject ModalService Modal

<h2>Apps</h2>

<div class="card">
    @if (IsLoading)
    {
        <p>Loading apps…</p>
    }
    else
    {
        <table class="table">
            <thead>
                <tr>
                    <th>Name</th>
                    <th>Client ID</th>
                    <th>Enabled</th>
                    <th style="width: 160px;">Actions</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var app in Apps)
                {
                    <tr>
                        <td>@app.Name</td>
                        <td>@app.ClientId</td>
                        <td>@(app.Enabled ? "Yes" : "No")</td>
                        <td>
                            <button class="btn btn-secondary" @onclick="() => Edit(app.Id)">Edit</button>
                            <button class="btn btn-danger" @onclick="() => Delete(app.Id)">Delete</button>
                        </td>
                    </tr>
                }
            </tbody>
        </table>
    }
</div>

<button class="fab" @onclick="Add">+</button>

@code {
    private List<AppDto> Apps = new();
    private bool IsLoading = true;

    protected override async Task OnInitializedAsync()
    {
        await LoadApps();
    }

    private async Task LoadApps()
    {
        try
        {
            IsLoading = true;
            Apps = await AppsService.GetAllAsync();
        }
        catch (SafeHttpException ex)
        {
            Toasts.ShowError(ex.Normalized.Message);
        }
        finally
        {
            IsLoading = false;
        }
    }

    private async Task Add()
    {
        var result = await Modal.OpenAsync<AppDialog, bool?>("New App");

        if (result is true)
            await LoadApps();
    }

    private async Task Edit(Guid id)
    {

        var result = await Modal.OpenAsync<AppDialog, bool?>(
            "Edit App",
            new() { { "AppId", id } }
            );

        if (result is true)
            await LoadApps();
    }

    private async Task Delete(Guid id)
    {
        if (!await Modal.ConfirmAsync("Delete this app?"))
            return;

        try
        {
            await AppsService.DeleteAsync(id);
            Toasts.ShowSuccess("App deleted");
            await LoadApps();
        }
        catch (SafeHttpException ex)
        {
            Toasts.ShowError(ex.Normalized.Message);
        }
    }
}