@page "/roles"
@inject ApplicationsApi AppsApi
@inject RolesApi RolesApi

<h3>Roles</h3>

@if (applications == null)
{
    <p>Loading applications…</p>
}
else
{
    <div class="mb-3">
        <label class="form-label">Select Application</label>
        <select class="form-select" @onchange="OnAppChanged">
            <option value="">Global Roles</option>
            @foreach (var app in applications)
            {
                <option value="@app.ApplicationId">@app.Name</option>
            }
        </select>
    </div>

    <button class="btn btn-primary mb-3" @onclick="NewRole">
        + New Role
    </button>

    @if (roles == null)
    {
        <p>Select an application to view roles.</p>
    }
    else if (roles.Count == 0)
    {
        <p>No roles found.</p>
    }
    else
    {
        <table class="table table-striped">
            <thead>
                <tr>
                    <th>Name</th>
                    <th>Application</th>
                    <th></th>
                </tr>
            </thead>
            <tbody>
                @foreach (var role in roles)
                {
                    <tr>
                        <td>@role.Name</td>
                        <td>@(role.ApplicationId == null ? "Global" : GetAppName(role.ApplicationId.Value))</td>
                        <td>
                            <button class="btn btn-sm btn-secondary me-2"
                                    @onclick="() => EditRole(role)">
                                Edit
                            </button>

                            <button class="btn btn-sm btn-danger"
                                    @onclick="() => DeleteRole(role.Id)">
                                Delete
                            </button>
                        </td>
                    </tr>
                }
            </tbody>
        </table>
    }
}

@if (isEditing)
{
    <hr />
    <h4>@(editingRoleId == Guid.Empty ? "Create Role" : "Edit Role")</h4>

    <div class="mb-3">
        <label class="form-label">Role Name</label>
        <input class="form-control" @bind="model.Name" />
    </div>

    <div class="mb-3">
        <label class="form-label">Application</label>
        <select class="form-select" @bind="model.ApplicationId">
            <option value="">Global Role</option>
            @foreach (var app in applications)
            {
                <option value="@app.ApplicationId">@app.Name</option>
            }
        </select>
    </div>

    <button class="btn btn-success me-2" @onclick="Save">
        Save
    </button>

    <button class="btn btn-secondary" @onclick="Cancel">
        Cancel
    </button>
}
<Error Errors="_errors" OnClear="HandleClear" />


@code {
    private List<ApplicationDto>? applications;
    private List<RoleDto>? roles;

    private Guid selectedAppId = Guid.Empty;

    private bool isEditing = false;
    private Guid editingRoleId = Guid.Empty;

    private CreateRoleRequest model = new();
    private List<string> _errors = new();

    protected override async Task OnInitializedAsync()
    {
        var (apps, errors) = await AppsApi.GetApplicationsAsync();
        if (errors.Any())
        {
            _errors = errors;
            return;
        }
        applications = apps;
    }

    private async Task OnAppChanged(ChangeEventArgs e)
    {
        var value = e.Value?.ToString();

        if (string.IsNullOrWhiteSpace(value))
        {
            selectedAppId = Guid.Empty;
        }
        else
        {
            selectedAppId = Guid.Parse(value);
        }

        (roles, _errors) = await RolesApi.GetRolesForAppAsync(selectedAppId);
    }

    private string GetAppName(Guid appId)
    {
        return applications?.FirstOrDefault(a => a.ApplicationId == appId)?.Name ?? "Unknown";
    }

    private void NewRole()
    {
        editingRoleId = Guid.Empty;
        model = new CreateRoleRequest();
        isEditing = true;
    }

    private void EditRole(RoleDto role)
    {
        editingRoleId = role.Id;

        model = new CreateRoleRequest
        {
            Name = role.Name,
            ApplicationId = role.ApplicationId
        };

        isEditing = true;
    }

    private async Task Save()
    {
        if (editingRoleId == Guid.Empty)
        {
            await RolesApi.CreateRoleAsync(model);
        }
        else
        {
            var update = new UpdateRoleRequest
            {
                Name = model.Name,
                ApplicationId = model.ApplicationId
            };

            await RolesApi.UpdateRoleAsync(editingRoleId, update);
        }

        (roles, _errors) = await RolesApi.GetRolesForAppAsync(selectedAppId);
        isEditing = false;
    }

    private void Cancel()
    {
        isEditing = false;
    }

    private async Task DeleteRole(Guid roleId)
    {
        await RolesApi.DeleteRoleAsync(roleId);
        (roles, _errors) = await RolesApi.GetRolesForAppAsync(selectedAppId);
    }

    private async Task HandleClear()
    {
        _errors?.Clear();
        await InvokeAsync(StateHasChanged);
    }
}
