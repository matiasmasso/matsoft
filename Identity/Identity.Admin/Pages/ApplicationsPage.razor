@page "/applications"
@inject ApplicationsApi AppsApi

<h3>Applications</h3>

@if (applications == null)
{
    <p>Loading applications…</p>
}
else
{
    <button class="btn btn-primary mb-3" @onclick="NewApplication">
        + New Application
    </button>

    <table class="table table-striped">
        <thead>
            <tr>
                <th>Name</th>
                <th>Client ID</th>
                <th>Active</th>
                <th></th>
            </tr>
        </thead>
        <tbody>
            @foreach (var app in applications)
            {
                <tr>
                    <td>@app.Name</td>
                    <td>@app.ClientId</td>
                    <td>
                        <input type="checkbox"
                               checked="@app.IsActive"
                               @onchange="e => ToggleActive(app, e)" />
                    </td>
                    <td>
                        <button class="btn btn-sm btn-secondary me-2"
                                @onclick="() => EditApplication(app)">
                            Edit
                        </button>

                        @if (app.ApplicationId != null)
                        {
                            <button class="btn btn-sm btn-danger"
                                    @onclick="() => DeleteApplication(app)">
                                Delete
                            </button>
                        }

                    </td>
                </tr>
            }
        </tbody>
    </table>
}

@if (model != null)
{
    <hr />
    <h4>@(isNew ? "Create Application" : "Edit Application")</h4>

    <div class="mb-3">
        <label class="form-label">Name</label>
        <input class="form-control" @bind="model.Name" />
    </div>

    <div class="mb-3">
        <label class="form-label">Client ID</label>
        <input class="form-control" @bind="model.ClientId" />
    </div>

    <div class="mb-3">
        <label class="form-label">Active</label>
        <input type="checkbox" @bind="model.IsActive" />
    </div>

    <button class="btn btn-success me-2" @onclick="Save">
        Save
    </button>

    <button class="btn btn-secondary" @onclick="Cancel">
        Cancel
    </button>
}

<Error Errors="_errors" OnClear="HandleClear" />


@code {
    private List<ApplicationDto>? applications;
    private List<string>? _errors = new();
    private bool isNew;

    private ApplicationDto? model;

    protected override async Task OnInitializedAsync()
    {
        (applications, _errors) = await AppsApi.GetApplicationsAsync();
    }

    private void NewApplication()
    {
        _errors?.Clear();
        model = new ApplicationDto(){};
        isNew = true;
    }

    private void EditApplication(ApplicationDto app)
    {
        _errors?.Clear();
        //clone the option to prevent persisting it if the user cancels the operation
        model = new ApplicationDto
        {
            ApplicationId = app.ApplicationId,
            Name = app.Name,
            ClientId = app.ClientId,
            IsActive = app.IsActive
        };
        isNew = false;
    }


    private async Task Save()
    {
        if (isNew)
            _errors = await AppsApi.CreateApplicationAsync(model);
        else
            _errors = await AppsApi.UpdateApplicationAsync(model);

        if (_errors == null || !_errors.Any())
        {
            if(isNew)
                applications!.Add(model);
            else
            {
                var index = applications!.FindIndex(a => a.ApplicationId == model.ApplicationId);
                applications[index].Name = model.Name;
                applications[index].ClientId = model.ClientId;
                applications[index].IsActive = model.IsActive;
            }
            model = null;
        }
    }

    private void Cancel()
    {
        model = null;
    }

    private async Task ToggleActive(ApplicationDto app, ChangeEventArgs e)
    {
        var oldValue = app.IsActive;
        app.IsActive = (bool)e.Value!;

        _errors = await AppsApi.UpdateApplicationAsync(app);

        if (_errors != null && _errors.Any())
        {
            // revert on error
            app.IsActive = oldValue;
        }
    }

    private async Task DeleteApplication(ApplicationDto app)
    {
        _errors = await AppsApi.DeleteApplicationAsync(app.ApplicationId!.Value);
        if(_errors == null || !_errors.Any())
            applications!.RemoveAll(a => a.ApplicationId == app.ApplicationId!.Value);
    }

    private async Task HandleClear()
    {
        _errors?.Clear();
        await InvokeAsync(StateHasChanged);
    }
}
