@page "/applications"
@inject ApplicationsApi AppsApi

<h3>Applications</h3>

@if (applications == null)
{
    <p>Loading applications…</p>
}
else
{
    <button class="btn btn-primary mb-3" @onclick="NewApplication">
        + New Application
    </button>

    <table class="table table-striped">
        <thead>
            <tr>
                <th>Name</th>
                <th>Client ID</th>
                <th>Active</th>
                <th></th>
            </tr>
        </thead>
        <tbody>
            @foreach (var app in applications)
            {
                <tr>
                    <td>@app.Name</td>
                    <td>@app.ClientId</td>
                    <td>
                        <input type="checkbox"
                               checked="@app.IsActive"
                               @onchange="e => ToggleActive(app, e)" />
                    </td>
                    <td>
                        <button class="btn btn-sm btn-secondary me-2"
                                @onclick="() => EditApplication(app)">
                            Edit
                        </button>

                        <button class="btn btn-sm btn-danger"
                                @onclick="() => DeleteApplication(app.ApplicationId)">
                            Delete
                        </button>
                    </td>
                </tr>
            }
        </tbody>
    </table>
}

@if (isEditing)
{
    <hr />
    <h4>@(editingAppId == Guid.Empty ? "Create Application" : "Edit Application")</h4>

    <div class="mb-3">
        <label class="form-label">Name</label>
        <input class="form-control" @bind="model.Name" />
    </div>

    <div class="mb-3">
        <label class="form-label">Client ID</label>
        <input class="form-control" @bind="model.ClientId" />
    </div>

    <div class="mb-3">
        <label class="form-label">Active</label>
        <input type="checkbox" @bind="model.IsActive" />
    </div>

    <button class="btn btn-success me-2" @onclick="Save">
        Save
    </button>

    <button class="btn btn-secondary" @onclick="Cancel">
        Cancel
    </button>
}

<Error Errors="_errors" OnClear="HandleClear" />


@code {
    private List<ApplicationDto>? applications;
    private List<string> _errors = new();

    private bool isEditing = false;
    private Guid editingAppId = Guid.Empty;

    private CreateApplicationRequest model = new();

    protected override async Task OnInitializedAsync()
    {
        var (apps, errors) = await AppsApi.GetApplicationsAsync();
        if (errors.Any())
        {
            _errors = errors;
            return;
        }
        applications = apps;
    }

    private void NewApplication()
    {
        editingAppId = Guid.Empty;
        model = new CreateApplicationRequest();
        isEditing = true;
    }

    private void EditApplication(ApplicationDto app)
    {
        editingAppId = app.ApplicationId;

        model = new CreateApplicationRequest
        {
            Name = app.Name,
            ClientId = app.ClientId,
            IsActive = app.IsActive
        };

        isEditing = true;
    }

    private async Task Save()
    {
        if (editingAppId == Guid.Empty)
        {
            await AppsApi.CreateApplicationAsync(model);
        }
        else
        {
            var update = new UpdateApplicationRequest
            {
                Name = model.Name,
                ClientId = model.ClientId,
                IsActive = model.IsActive
            };

            await AppsApi.UpdateApplicationAsync(editingAppId, update);
        }

        var (apps, errors) = await AppsApi.GetApplicationsAsync();
        if (errors.Any())
        {
            _errors = errors;
            return;
        }
        applications = apps;
        isEditing = false;
    }

    private void Cancel()
    {
        isEditing = false;
    }

    private async Task ToggleActive(ApplicationDto app, ChangeEventArgs e)
    {
        bool isActive = (bool)e.Value!;

        var update = new UpdateApplicationRequest
        {
            Name = app.Name,
            ClientId = app.ClientId,
            IsActive = isActive
        };

        await AppsApi.UpdateApplicationAsync(app.ApplicationId, update);

        app.IsActive = isActive;
    }

    private async Task DeleteApplication(Guid appId)
    {
        await AppsApi.DeleteApplicationAsync(appId);
        var (apps, errors) = await AppsApi.GetApplicationsAsync();
        if (errors.Any())
        {
            _errors = errors;
            return;
        }
        applications = apps;
    }

    private async Task HandleClear()
    {
        _errors?.Clear();
        await InvokeAsync(StateHasChanged);
    }
}
