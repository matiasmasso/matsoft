@page "/admin/users"

@using Identity.DTO
@inject ApplicationsApi ApplicationsApi

<div class="container-fluid">
    <div class="row">

        <!-- Columna 1: Usuaris -->
        <div class="col-3 border-end">
            <h4 class="mb-3">Usuaris</h4>

            <UsersList Users="users"
                      SelectedUserId="selectedUser?.Id"
                      OnUserSelected="HandleUserSelected" />
        </div>

        <!-- Columna 2: Aplicacions -->
        <div class="col-4 border-end">
            <h4 class="mb-3">Aplicacions</h4>

            <UserApplications User="selectedUser"
                              Applications="applications"
                              SelectedAppId="selectedAppId"
                              UsersApi="UsersApi"
                              OnAppSelected="HandleAppSelected" />
        </div>

        <!-- Columna 3: Rols -->
        <div class="col-5">
            <h4 class="mb-3">Rols</h4>

            <UserRoles User="selectedUser"
                       AppId="selectedAppId"
                       Roles="roles"
                       Values="assignedRoles"
                       UsersApi="UsersApi" />
        </div>

    </div>
</div>

<Error Errors="_errors" OnClear="HandleClear" />

@code {
    // API clients injectats
    [Parameter] public UsersApi UsersApi { get; set; } = default!;
    [Parameter] public RolesApi RolesApi { get; set; } = default!;

    // Dades carregades
    private List<UserDto>? users;
    private List<ApplicationDto>? applications;
    private List<RoleDto>? roles;

    // Estat actual
    private UserDto? selectedUser;
    private Guid selectedAppId = Guid.Empty;
    private HashSet<Guid> assignedRoles = new();
    private List<string>? _errors;

    protected override async Task OnInitializedAsync()
    {
        (users, _errors) = await UsersApi.GetUsersAsync();
        (applications, _errors) = await ApplicationsApi.GetApplicationsAsync();
    }

    private async Task HandleUserSelected(UserDto user)
    {
        selectedUser = user;
        selectedAppId = Guid.Empty;
        roles = null;
        assignedRoles.Clear();

        await InvokeAsync(StateHasChanged);
    }

    private async Task HandleAppSelected(Guid appId)
    {
        if (selectedUser is null)
            return;

        selectedAppId = appId;

        // Carrega rols disponibles per a l'aplicació
        (roles, _errors) = await RolesApi.GetRolesForAppAsync(appId);

        // Filtra rols assignats al user per aquesta app
        assignedRoles = selectedUser.Roles
            .Where(r => r.ApplicationId == appId)
            .Select(r => r.RoleId)
            .ToHashSet();

        await InvokeAsync(StateHasChanged);
    }

    private async Task HandleClear()
    {
        _errors?.Clear();
        await InvokeAsync(StateHasChanged);
    }
}