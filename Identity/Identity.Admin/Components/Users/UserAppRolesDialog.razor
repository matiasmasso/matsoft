@using Identity.Contracts.Apps
@using Identity.Contracts.Users
@inject IAppRolesService AppRoles
@inject IUserAppRolesService UserAppRoles
@inject ModalService Modal

<div class="dialog-body">
    <h3>Manage Roles</h3>

    @if (Roles is null)
    {
        <p>Loading...</p>
    }
    else
    {
        <ul class="roles-list">
            @foreach (var role in Roles)
            {
                <li>
                    <input type="checkbox"
                           checked="@role.Assigned"
                           @onchange="e => role.Assigned = (bool)e.Value!" />
                    @role.Name
                </li>
            }
        </ul>
    }

    <div class="dialog-actions">
        <button class="btn" @onclick="Save" disabled="@Saving">Save</button>
        <button class="btn" @onclick="Cancel">Cancel</button>
    </div>
</div>

@code {
    [Parameter] public Guid UserId { get; set; }
    [Parameter] public Guid AppId { get; set; }

    private List<AppRoleAssignmentDto>? Roles;
    private bool Saving;

    protected override async Task OnInitializedAsync()
    {
        Roles = (await UserAppRoles.GetRoleAssignmentsAsync(UserId, AppId)).Value;
    }

    private async Task Save()
    {
        Saving = true;

        var request = new UpdateUserAppRolesRequest
        {
            UserId = UserId,
            AppId = AppId,
            RoleIds = Roles
                .Where(r => r.Assigned)
                .Select(r => r.Id)
                .ToList()
        };

        await UserAppRoles.UpdateAssignmentsAsync(request);

        Saving = false;
        Modal.Close(true);
    }

    private void Cancel() => Modal.Close(false);
}