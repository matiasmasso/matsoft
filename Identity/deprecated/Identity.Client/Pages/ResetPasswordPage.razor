@page "/reset-password"
@layout AuthLayout
@using System.Web
@inject NavigationManager NavigationManager
@inject HttpClient Http

<h3 class="mb-3 text-center">Reset Password</h3>

@if (error != null)
{
    <div class="alert alert-danger">@error</div>
}

@if (success != null)
{
    <div class="alert alert-success">@success</div>
}

<EditForm Model="@model" OnValidSubmit="Submit">
    <DataAnnotationsValidator />

    <div class="mb-3">
        <label>New Password</label>
        <InputText @bind-Value="model.NewPassword" type="password" class="form-control" />
    </div>

    <div class="mb-3">
        <label>Confirm Password</label>
        <InputText @bind-Value="confirmPassword" type="password" class="form-control" />
    </div>

    <button class="btn btn-primary w-100" disabled="@isSubmitting">
        @(isSubmitting ? "Processing..." : "Reset Password")
    </button>
</EditForm>

<div class="text-center mt-3">
    <a href="/login">Back to login</a>
</div>

@code {
    ResetPasswordRequest model = new();
    string confirmPassword;
    string error;
    string success;
    bool isSubmitting = false;

    protected override void OnInitialized()
    {
        var uri = NavigationManager.ToAbsoluteUri(NavigationManager.Uri);
        var query = HttpUtility.ParseQueryString(uri.Query);

        model.Email = query["email"];
        model.Token = query["token"];
    }

    async Task Submit()
    {
        error = null;
        success = null;

        if (model.NewPassword != confirmPassword)
        {
            error = "Passwords do not match.";
            return;
        }

        isSubmitting = true;

        var response = await Http.PostAsJsonAsync("api/auth/reset-password", model);

        isSubmitting = false;

        if (!response.IsSuccessStatusCode)
        {
            error = await response.Content.ReadAsStringAsync();
            return;
        }

        success = "Your password has been reset.";

        await Task.Delay(2000);
        NavigationManager.NavigateTo("/login");
    }
}