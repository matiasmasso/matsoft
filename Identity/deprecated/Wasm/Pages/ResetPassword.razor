@page "/reset-password"
@inject AuthApiClient Auth
@inject NavigationManager Nav

<h3>Reset password</h3>

@if (_invalid)
{
    <p style="color:red">Invalid reset link.</p>
}
else
{
    <EditForm Model="_model" OnValidSubmit="OnSubmit">
        <DataAnnotationsValidator />
        <ValidationSummary />

        <InputText @bind-Value="_model.NewPassword" type="password" placeholder="New password" />
        <button type="submit">Reset</button>
    </EditForm>

    @if (_done)
    {
        <p>Password reset successfully. You can now <a href="/login">log in</a>.</p>
    }
}

@code {
    private Model _model = new();
    private string? _email;
    private string? _token;
    private bool _invalid;
    private bool _done;

    public class Model
    {
        public string NewPassword { get; set; } = "";
    }

    protected override void OnInitialized()
    {
        var uri = Nav.ToAbsoluteUri(Nav.Uri);
        var query = System.Web.HttpUtility.ParseQueryString(uri.Query);
        _email = query["email"];
        _token = query["token"];

        if (string.IsNullOrEmpty(_email) || string.IsNullOrEmpty(_token))
            _invalid = true;
    }

    private async Task OnSubmit()
    {
        if (_invalid || _email is null || _token is null)
            return;

        await Auth.ResetPasswordAsync(_email, _token, _model.NewPassword);
        _done = true;
    }
}
